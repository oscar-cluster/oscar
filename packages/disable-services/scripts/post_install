#!/bin/sh
#
# Copyright (c) 2004 The Trustees of Indiana University.  
#                    All rights reserved.
# 
# This file is part of the OSCAR software package.  For license
# information, see the COPYING file in the top level directory of the
# OSCAR source distribution.
#
# $Id: post_install,v 1.0 2004/08/13 donginn Exp $
#


#
# Configure the list of all nodes for *mynetworks* in the server file system
#

# Check if postfix, sendmail, or exim rpm is installed
# If any one of them is installed, return the package name
# and then the configuration file corresponding to the package name is configured
# for only localhost.
# Otherwise, it throws an error.

# The list of the mailing service rpms
services="postfix sendmail exim"
for service in $services; do

    # See if this is supposed to run when computer boots up.
    chkconfig --list $service > /dev/null 2>&1
    if test "$?" = "0"; then
	service_name=$service

	# If any above rpm is running,
	# assign the name of the rpm found to the variable $service_name
	# and then break out the 'for' loop 

	break
    fi
done


	# If $service_name contains the "postfix, sendmail, or exim",
    # each case handles the configuration corresponding to
	# the installed rpm for the localhost only.
    # Otherwise, the error will be thrown.

case "$service_name" in
	postfix) echo "POSTFIX is running"

        # The list of configuration files possible for the Postfix
        # in the current linux distro. 

        configure_files="/etc/postfix/main.cf /etc/main.cf /usr/lib/postfix/main.cf"
        found=0
        for file in $configure_files; do
            if test -n "$found" -a -f $file -a -n "`grep postfix $file`"; then
                found=1
                break
            fi
        done

        if test $found = "1"; then
            postfix_conf=$file
            # Make a backup copy of the postfix config file before editing it.
            cp $file $file.bak
            
            cat $postfix_conf > main.cf.server.$$
            nodes=$(echo `oda nodes` | sed 's/ /, /g')
            cat >> main.cf.server.$$ << EOF

# Allow the mail to access to only the following list of nodes by setting the 'mynetworks'
mynetworks = $nodes

#
# END OF ADDED CONFIGURATION OPTIONS FOR OSCAR
#

EOF

            cp main.cf.server.$$ $postfix_conf
    	    rm -rf main.cf.server.$$
            echo "Postfix is succesfully configured. : SERVER NODE";
            
            # Restart postfix.
            /etc/init.d/postfix stop
            /etc/init.d/postfix start

            echo "- finished configuring postfix"
        else
            echo "WARNING: I could not find postfix's configuration file!"
            echo "WARNING: There will be no mail service running on the client nodes!"
        fi
		;;
	sendmail)
    echo "WARNING: OSCAR does not know how to configure sendmail yet."
    echo "WARNING: Please bug the OSCAR developers to finish the disable-servics package!"
    echo "WARNING: There will be no mail service running on the client nodes!"
		;;
	exim)
    echo "WARNING: OSCAR does not know how to configure exim yet."
    echo "WARNING: Please bug the OSCAR developers to finish the disable-servics package!"
    echo "WARNING: There will be no mail service running on the client nodes!"
		;;
	*) echo "WARNING: OSCAR did not found any mailing service"
        ;;
esac

exit 0;
