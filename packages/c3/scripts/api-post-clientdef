#!/usr/bin/perl
# $Id$
#
# script to generate the /etc/c3.conf file from the cluster definition file
#
# Author:
#
# Brian Leuthke
# Copyright (c) 2008 Geoffroy Vallee <valleegr@ornl.gov>
#                    Oak Ridge National Laboratory
#                    All rights reserved.# Last Updated: 10/10/2000, 5/15/2002
#

use strict;
use lib '/usr/lib/systeminstaller';
use SystemInstaller::Machine;
use OSCAR::ConfigFile;
use Data::Dumper;
use Carp;

my $image_name = shift;

my %hash = SystemInstaller::Machine::get_machine_listing($image_name);

# TODO: make sure we feed the c3_conf_manager script with a correctly sorted
# list of nodes. Typically the sorting function has to be revisited to handle
# fancy schemes like the one described in ticket #143
my @hosts = sortnodes( keys %hash );
my $binaries_path = OSCAR::ConfigFile::get_value ("/etc/oscar/oscar.conf",
                                                  undef,
                                                  "OSCAR_SCRIPTS_PATH");
my $c3mgr = "$binaries_path/c3_conf_manager";

# TODO: We should ALWAYS specify the conf file we target.
!system("$c3mgr --rm oscar_cluster && $c3mgr --add oscar_cluster " . join(' ', @hosts)) or 
	die ("ERROR: I couldn't manage to update the C3 configuration!\n");

# Use Schwartzian transform to sort node names alphabetically and numerically.
# Names w/o numeric suffix preceed those with numeric suffix.
sub sortnodes(@) {
	return map { $_->[0] }
	       sort { $a->[1] cmp $b->[1] || ($a->[2]||-1) <=> ($b->[2]||-1) }
	       map { [$_, /^([\D]+)([\d]*)$/] }
	       @_;
}

exit 0;

__END__

