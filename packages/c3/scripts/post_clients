#!/usr/bin/perl
# $Id: post_clients,v 1.4 2002/12/16 03:04:14 naughtont Exp $
#
# gen_c3_conf - script to generate the /etc/c3.conf file from the ORNL
#               cluster definition file
# Author: Brian Leuthke
# Last Updated: 10/10/2000, 5/15/2002


use strict;
use Carp;
use lib '/usr/lib/systeminstaller';
use SystemInstaller::Machine;
use Data::Dumper;

my $image = shift;

my $c3_conf = "/etc/c3.conf";

my $hostname = `hostname`;
chomp($hostname);

my %hash = get_machine_listing($image);

open(OUT,">$c3_conf") or croak("Couldn't open $c3_conf");
print OUT "cluster oscar_cluster {\n";
print OUT "\t$hostname\n";
my $firstkey = 1;
foreach my $key (sort numerically keys %hash) {
    if ($firstkey)
      {
        $hash{$key}->{HOST} =~ /([a-zA-Z_\-]+)(\d*)/;
        print OUT "\tdead remove_line_for_0-indexing\n" if 
          (defined($2) && ($2 != 0));
        $firstkey = 0;
      }
    print OUT "\t", $hash{$key}->{HOST}, "\n";
}
print OUT "}\n";
close(OUT);



# Sort hostnames numerically instead of an ascii sort.
# Special sort() sub-rtn (uses $a, $b instead of @_)
sub numerically
{
	$a =~ /(\d+)$/;	 # pickoff number and
	my $A = $1;	     #  save in local var

	$b =~ /(\d+)$/;	 # pickoff number and
	my $B = $1;	     #  save in local var

	($A <=> $B)
}
