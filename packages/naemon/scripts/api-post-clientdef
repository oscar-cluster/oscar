#!/usr/bin/env perl

# Copyright (C) 2014 Olivier Lahaye <olivier.lahaye@cea.fr>
#                    All rights reserved

# Post install action to start naemon service. We can't start it before
# otherwize, non yet deployed nodes would trigger some alarms.

use Carp;
# use OSCAR::Opkg;
# use OSCAR::Package;
use OSCAR::Logger;
use OSCAR::LoggerDefs;
#use OSCAR::OCA::OS_Settings;
use OSCAR::MonitoringMgt;
use SystemInstaller::Machine;

my $image_name = shift;
    
if (! defined ($image_name)) {
    oscar_log(1, ERROR, "Missing image name. Can't continue.");
    exit 1;
}

my %hash = SystemInstaller::Machine::get_machine_listing($image_name);
# TODO: test that %hash exists

oscar_log(2, INFO, "Creating naemon nodes configs");

# Easyer to create nodes here as we can easily get the IP address.

my @nodes = keys(%hash);
for my $node (@nodes) {
    my $name = $node; # Try to use DNS name
    my $alias = $node;
    my $ip = $hash{$node}->{IPADDR};
    # TODO: valid string and valid ip.
    write_oscar_host_cfg($name, $alias, $ip);
}

# Host groups will be defined at post-deploy.
# (at this time we may have incomplet nodes defined. some images may be still not populated with nodes)

exit 0;
