#!/bin/sh
# $Id: $
# Copyright (c) 2013, CEA² Commissariat à l'Énergie Atomique et Énergies Alternatives
#                     All rights reserved.

#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
 
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
 
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# End of legal notices
# Authors: Olivier LAHAYE

# Purpose: test_root: Perform tests on munge installation to check that authentication
# is working on the head and between nodes and the head.

# DEBUG
echo "MUNGE #:$# 0:$0 1:$1 2:$2 3:$3 4:$4"

# DEBUG messages are redirected to File descriptor 5
if test 0${OSCAR_VERBOSE} -gt 4
then
	# DEBUG: File descriptor 5 is a clone of std out
exec 5<&1
else
	# No DEBUG: File descriptor 5 is redirected to /dev/null
exec 5>/dev/null
fi

function Test_MUNGE_Perm() {
TEST_LABEL=$1
FILE=$2
PERM=$3

$OSCAR_TESTPRINT --label "$TEST_LABEL"

if test -n "$(LC_ALL=C /bin/ls -ld $FILE |grep -- "$PERM")"
then
  $OSCAR_TESTPRINT --label "$TEST_LABEL" -p
  return 0
else
  $OSCAR_TESTPRINT --label "$TEST_LABEL" -f
  return 1
fi
}

# Test that /etc/munge/munge.key has permission 0400
Test_MUNGE_Perm "/etc/munge/munge.key perms: 0400" /etc/munge/munge.key "-r--------"

# Test that /var/lib/munge/ Has permission 0700
Test_MUNGE_Perm "/var/lib/munge/      perms: 0700" /var/lib/munge       "drwx------"

# Test that /var/log/munge/ has permission 0711
Test_MUNGE_Perm "/var/log/munge/      perms: 0711" /var/log/munge       "drwx--x--x"

# Test that /var/run/munge/ has permission 0755
Test_MUNGE_Perm "/var/run/munge/      perms: 0755" /var/run/munge       "drwxr-xr-x"

# Test munge -n | unmunge
TEST_LABEL="MUNGE: Testing munge -n | unmunge"
echo "$TEST_LABEL" >&5
if munge -n | unmunge >&5 2>&5
then
	$OSCAR_TESTPRINT --label "$TEST_LABEL" -p
else
	$OSCAR_TESTPRINT --label "$TEST_LABEL" -f
fi

# Test munge -n | ssh somehost unmunge
# Get all nodes names including head into table ALL_NODES
echo "MUNGE: Testing all nodes with: munge -n | ssh $NODE unmunge" >&5 2>&5
ALL_NODES=( $(mysql -u root oscar -B -N -e 'select name from Nodes;') )
for NODE in ${ALL_NODES[@]}
do
	TEST_LABEL="MUNGE: Testing munge -n | ssh $NODE unmunge"
	if munge -n | ssh $NODE unmunge >&5 2>&5
	then
		$OSCAR_TESTPRINT --label "$TEST_LABEL" -p
	else
		$OSCAR_TESTPRINT --label "$TEST_LABEL" -f
	fi
done

# Run a small benchmark remunge

TEST_LABEL="MUNGE: remunge benchmark"
echo "$TEST_LABEL" >&5 2>&5
if remunge >&5 2>&5
then
        $OSCAR_TESTPRINT --label "$TEST_LABEL" -p
else
        $OSCAR_TESTPRINT --label "$TEST_LABEL" -f
fi

# END
