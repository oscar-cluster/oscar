#!/bin/sh
##
## This script sets up the envirnoment as needed.
## So, run this script instead of running these tests directly.
##
## To run a subset of tests, pass them as script arguments.
##
## This script creates temporary files in a subdirectory of
## $TMPDIR (defaulting to /tmp if $TMPDIR is unset).
##

# The bulk of this file is based on the "check-TESTS" target
# in a Makefile.in generated by automake, which carries the
# following two notices:

# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
# 2003, 2004, 2005  Free Software Foundation, Inc.
# This Makefile.in is free software; the Free Software Foundation
# gives unlimited permission to copy and/or distribute it,
# with or without modifications, as long as this notice is preserved.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE.

# End of legal notices

function Test_MUNGE_Perm() {
TEST_LABEL=$1
FILE=$2
PERM=$3

$OSCAR_TESTPRINT --label $TEST_LABEL

if test -n "$(LC_ALL=C /bin/ls -ld $FILE |grep -- \"$PERM\")"
then
  $OSCAR_TESTPRINT --label $TEST_LABEL -p
else
  $OSCAR_TESTPRINT --label $TEST_LABEL -f
  echo   '###################################################################'
  echo   '#### MUNGE permissions are not correct for $FILE ####'
  echo   '###################################################################'
  exit 1
fi
}

# Test that /etc/munge/munge.key has permission 0400
Test_MUNGE_Perm "/etc/munge/munge.key perms: 0400" /etc/munge/munge.key "-r--------"

# Test that /var/lib/munge/ Has permission 0700
Test_MUNGE_Perm "/var/lib/munge/      perms: 0700" /var/lib/munge       "drwx------"

# Test that /var/log/munge/ has permission 0711
Test_MUNGE_Perm "/var/log/munge/      perms: 0711" /var/lib/munge       "drwx--x--x"

# Test that /var/run/munge/ has permission 0755
Test_MUNGE_Perm "/var/run/munge/      perms: 0755" /var/lib/munge       "drwxr-xr-x"

# Test munge -n | unmunge
TEST_LABEL="MUNGE: Testing munge -n | unmunge"
$OSCAR_TESTPRINT --label $TEST_LABEL
if munge -n | unmunge
then
	$OSCAR_TESTPRINT --label $TEST_LABEL -p
else
	$OSCAR_TESTPRINT --label $TEST_LABEL -f
fi

# Test munge -n | ssh somehost unmunge
# TODO

# Run a small benchmark remunge

TEST_LABEL="MUNGE: remunge benchmark"
$OSCAR_TESTPRINT --label $TEST_LABEL
if remunge
then
        $OSCAR_TESTPRINT --label $TEST_LABEL -p
else
        $OSCAR_TESTPRINT --label $TEST_LABEL -f
fi

# END
