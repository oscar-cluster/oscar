#!/usr/bin/perl -w

#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.

#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.

#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

#   ganglia Server Preparation script
#   Steven A. DuChene  <linux-clusters@mindspring.com>
#   mandrake msec modification : Benoit des Ligneris <benoit@des.ligneris.net>
# Copyright (c) 2003 The Trustees of Indiana University.  
#                    All rights reserved.

use strict;
use Carp;

# Make sure httpd is on and started
!system("chkconfig httpd on") or croak("Couldn't chkconfig httpd on");
!system("service httpd start") or croak("Couldn't start httpd");

# call script that makes the mod to the gmond.conf and gmetad.conf files for the internal interface

!system("$ENV{OSCAR_PACKAGE_HOME}/scripts/gmond_add_internal.sh") or croak("gmond_internal.sh failed");

!system("service gmond start") or croak("Couldn't start gmond");
!system("service gmetad start") or croak("Couldn't start gmetad");

# Test if Mandrake Security is installed and modify the permission for
# /var/log/ganglia as requested for ganglia-php 

if (`rpm -q msec --queryformat "%{NAME}"` eq "msec") {
	# msec is installed
	# Have to adjust the security for /var/log/ganglia

	if (`grep "#OSCAR msec modification" /etc/security/msec/perm.local`)
		{
			system("/bin/chmod -R ugo+rx /var/log/ganglia/");
			print "msec modification already done for ganglia                      [  OK  ]\n";
		}
	else
		{
			open (MSEC,">>/etc/security/msec/perm.local") or
			croak ("No /etc/security/msec/perm.local found !");

			print MSEC <<__EOF
#OSCAR msec modification
/var/log/ganglia				root.root		755
/var/log/ganglia/*				root.root		755
/var/log/ganglia/rrds/*				root.root		755
__EOF
;

			close MSEC ;
			system("/bin/chmod -R ugo+rx /var/log/ganglia/");
			print "OSCAR msec Modification for ganglia                             [  OK  ]\n";
}
}
else
{
print "msec not installed                                              [  OK  ]\n";
}

