#!/bin/sh

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

# This script checks to see if the number of OSCAR clients (+ headnode)
# equals the number of hosts Ganglia sees by using gstat

# (C)opyright Bernard Li <bli@bcgsc.ca>
#             Erich Focht <efocht@hpce.nec.com>

log=ganglia/ganglia.err

# remove old log file
if test -f $log
then
  rm -rf ganglia/ganglia.err
fi

label="Ganglia setup test"

# Get number of args (nodes)
clients=`echo $@ | wc -w`

# number of client nodes + headnode
numhosts=`expr $clients + 1`

# use gstat to determine number of hosts ganglia has detected 
pattern=`hostname`"|"`perl -e "print join(\"|\",split(\" +\",\"$@\"));"`

# simple test which counts the number of detected nodes (via gstat) with
# the number of expected nodes (from argument)
# the nodes detected have to match a certain pattern (belonging to the
# cluster) and thus will pass even if you have other gmonds running on the
# same network but not belonging to the same data source
hosts=`gstat --all | egrep -c "^($pattern)$"`

if [ $hosts -eq $numhosts ]
then
  $OSCAR_TESTPRINT --label "$label" -p
else
  echo "Client nodes: $@" > $log
  echo "Match pattern: $pattern" >> $log
  echo "Number of hosts matched: $hosts" >> $log
  echo "Gstat output:" >> $log
  gstat --all >> $log
  echo -e "\nThe number of nodes expected is different from the number of nodes detected.\nCheck to see if gmond is running on all your nodes and make sure that you\nare not having any network issues." >> $log
  $OSCAR_TESTPRINT --label "$label" -f
  exit 1
fi

# more stringent test, will fail if number of detected nodes > expected nodes
# this is a hard count and does not do any pattern matching - this is used to
# notify users of renegade nodes in their OSCAR ganglia setup - failing this
# test is not fatal
hosts=`gstat | grep 'Hosts' | head -n 1 | awk {'print $2'}`

label="Ganglia node count test"

if [ $hosts -eq $numhosts ]
then
  $OSCAR_TESTPRINT --label "$label" -p
else
  echo -e "Ganglia expects to have $numhosts nodes but found $hosts nodes.  Please check to see\nif there are non-OSCAR cluster gmond(s) running on the same network/switch\nand correct the problem.  This test failure is not catastrophic, it\nis safe to ignore if \"Ganglia setup test\" succeeds." > $log
  $OSCAR_TESTPRINT --label "$label" -f
  exit 1
fi
exit 0
