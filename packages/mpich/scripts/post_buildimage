#!/usr/bin/perl

use strict;
use Carp;

my $image = shift;
my $VER = "1.2.1";
my $RELEASE = ".2oscar";
my $ARCH = "i386";
my $PREFIX = "/opt/mpich-$VER";
my $imagedir = "/var/lib/systemimager/images/$image";

my $file = "$imagedir/etc/profile.d/mpi-00mpich.sh";
open( OUT, ">$file" ) or croak( "Couldn't open $file" );

print OUT <<EOF;
#
# Append MPIch bin directory to PATH
# Part of the OSCAR install
#
[[ -z \$MPICH ]] && {
  export MPICH=$PREFIX
  [[ :\$PATH: != *:\$MPICH/bin:* ]] && export PATH=\$PATH:\$MPICH/bin
  if [[ -z \$MANPATH ]]; then
    export MANPATH="\$MPICH/man"
  else
    export MANPATH="\${MANPATH}:\$MPICH/man"
  fi
}
EOF
close( OUT );
chmod 0755, "$file";

$file = "$imagedir/etc/profile.d/mpi-00mpich.csh";
open( OUT, ">$file" ) or croak( "Couldn't open $file" );
print OUT <<EOF;
#
# Append MPIch bin directory to PATH
# Part of the OSCAR install
#
if (\$?MPICH == "0") then
  set MPICH="$PREFIX"
  set path = (\$path \$MPICH/bin)
  if (\$?MANPATH == "0") then
    set MANPATH="\$MPICH/man"
  else
    set MANPATH="\${MANPATH}:\$MPICH/man"
  endif
endif
EOF
close( OUT );
chmod 0755, "$file";


#
# THIS IS AN UGLY HACK!  We need to make sure that the head node has the
# /etc/profile.d scripts for MPICH.  This is the easiest place to do
# this for 1.2.  For 1.3, this should be removed and made better
# somehow.
#
my $file = "/etc/profile.d/mpi-00mpich.sh";
if (! -f $file) {
open( OUT, ">$file" ) or croak( "Couldn't open $file" );

print OUT <<EOF;
#
# Append MPIch bin directory to PATH
# Part of the OSCAR install
#
[[ -z \$MPICH ]] && {
  export MPICH=$PREFIX
  [[ :\$PATH: != *:\$MPICH/bin:* ]] && export PATH=\$PATH:\$MPICH/bin
  if [[ -z \$MANPATH ]]; then
    export MANPATH="\$MPICH/man"
  else
    export MANPATH="\${MANPATH}:\$MPICH/man"
  fi
}
EOF
close( OUT );
chmod 0755, "$file";
}

$file = "/etc/profile.d/mpi-00mpich.csh";
if (! -f $file) {
open( OUT, ">$file" ) or croak( "Couldn't open $file" );
print OUT <<EOF;
#
# Append MPIch bin directory to PATH
# Part of the OSCAR install
#
if (\$?MPICH == "0") then
  set MPICH="$PREFIX"
  set path = (\$path \$MPICH/bin)
  if (\$?MANPATH == "0") then
    set MANPATH="\$MPICH/man"
  else
    set MANPATH="\${MANPATH}:\$MPICH/man"
  endif
endif
EOF
close( OUT );
chmod 0755, "$file";
}
