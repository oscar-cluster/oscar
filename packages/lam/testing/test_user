#!/bin/sh
#
# Copyright (c) 2002-2005 The Trustees of Indiana University.  
#                         All rights reserved.
# 
# This file is part of the OSCAR software package.  For license
# information, see the COPYING file in the top level directory of the
# OSCAR source distribution.

# $Id: test_user,v 1.2 2002/10/31 15:47:17 jsquyres Exp $
#
# Authors: Jason Brechin
#          Jeremy Enos
#	   Bernard Li
#          Jeffrey M. Squyres

if test -e /usr/share/doc/openpbs*; then
   scheduler="PBS"
else
   scheduler="Torque"
fi

cd
clients=`echo $@ | wc -w`
testprint_label="LAM/MPI (via $scheduler)"

# Sanity check (somewhat overkill, but safe = good): check to see that
# there is a LAM installed.

lam="`switcher mpi --list | grep lam | head -1`"
if test -z "$lam"; then
    $OSCAR_TESTPRINT --label "$testprint_label"
    $OSCAR_TESTPRINT --label "$testprint_label" --skipped
    exit 0
fi

# If the user has a default MPI set in switcher, save it.  Then set
# LAM/MPI to be the default.

user_default_mpi="`switcher mpi --show --user | grep default | cut -d= -f2`"
switcher mpi --add-attr default $lam --force --silent

############################################################################
# Do horrid checking to see if this has NFS propagated out to all the
# nodes yet (per several bugs on the SF bug tracker).  This has nothing
# to do with the MPI test, but if the NFS propagation doesn't occur in
# a timely fashion, the MPI test will fail (because PATHs will be set
# wrong, etc.).  So we have to wait until the NFS dust settles before
# we can run the test.

check_nfs_prop() {
    want_prompt=$1
    nfs_goodness=no
    if test "$want_prompt" = "yes"; then
        echo -n "Checking for NFS propagation of MPI preferences... "
    fi
    foo="`cexec switcher mpi --show | egrep '^user:default=' | cut -d= -f 2 | sort | uniq`"
    if test "$foo" = "$lam"; then
        nfs_goodness=yes
        if test "$want_prompt" = "yes"; then
            echo "Good!"
        fi
    else
        if test "$want_prompt" = "yes"; then
            echo "Not yet"
        fi
    fi
}

check_nfs_prop no
while test "$nfs_goodness" = "no"; do
    sleep 1
    check_nfs_prop yes
done

# End of horrid NFS checking
############################################################################

# Now run the test (results will be printed by the test itself)

$HOME/pbs_test $clients 1 $HOME/lam/pbs_script.lam "Hello" \
    $HOME/lam/lamtest 3 "$testprint_label"
exit_status=$?

# If there was a user default set in switcher, set it back
# Otherwise, just remove the default that we set in this script.

if test -n "$user_default_mpi"; then
    switcher mpi --add-attr default $user_default_mpi --force --silent
else
    switcher mpi --rm-attr default --force --silent
fi

# All done

exit $exit_status
