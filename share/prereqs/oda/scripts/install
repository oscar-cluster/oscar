#!/usr/bin/env perl

# Copyright © 2003, The Board of Trustees of the University of Illinois. All rights reserved.
# Copyright (c) 2002 The Trustees of Indiana University.  
#                    All rights reserved.
# 
# This file is part of the OSCAR software package.  For license
# information, see the COPYING file in the top level directory of the
# OSCAR source distribution.
#
# $Id: install,v 1.9 2003/06/24 15:12:43 brechin Exp $
#

#use strict;
use lib "$ENV{OSCAR_HOME}/lib";
use OSCAR::Logger;
use Carp;
use OSCAR::Distro;
use OSCAR::Package;
use XML::Simple;
use File::Copy;

# Version included in media directory

my $ver = "0.90";
my $package_dir = "oda";
my $package_rpms_dir = "$ENV{OSCAR_HOME}/packages/$package_dir/RPMS";
my $oscar_rpms_dir = "/tftpboot/rpm";

oscar_log_subsection("Checking to see if we need to install ODA RPMs");

# Definition of distro type and version

my ($distro_name, $distro_version) = which_distro_server();

# find a list of rpm names to check for and rpm files to install

if ($distro_name eq "redhat") {
    @wanted_rpms = qw( mysql
		perl-DBD-MySQL
		perl-DBI
		mysql-server
		oda );
    my $mysqld   = 'mysqld';
}

if ($distro_name eq "SuSE") {
    @wanted_rpms = qw( mysql
		mysql-client
		perl-Msql-Mysql-modules
		perl-DBI
		perl-Data-ShowTable
		mysql-shared
		oda );
    my $mysqld   = 'mysql';
    my $src = $ENV{"OSCAR_HOME"} . "/packages/oda/config.xml.SuSE";
    my $dest = $ENV{"OSCAR_HOME"} . "/packages/oda/config.xml";
    copy($src, $dest) || croak("Could not copy $src to $dest");
}

# If we're on Mandrake, abort.  ODA will not be installed.

elsif ($distro_name eq "mandrake") { 
    @wanted_rpms = qw( MySQL
		MySQL-client
		libmysql10
		perl-DBI
		perl-Mysql
		perl-ExtUtils-PerlPP
		oda );
    my $mysql    = 'mysql';
    # FIXME (bligneri)
    # Will just copy the XML file.
    # Should be an argument in the XML file.
    #my $xs = new XML::Simple(forcearray => 1, keeproot => 1);
    #my $config = $xs->XMLin($ENV{"OSCAR_HOME"}."/packages/oda/config.xml");
    my $src = $ENV{"OSCAR_HOME"} . "/packages/oda/config.xml.mandrake";
    my $dest = $ENV{"OSCAR_HOME"} . "/packages/oda/config.xml";
    copy($src, $dest) ||
	croak("Could not copy $src to $dest");
}

# read in the file names in this package's RPMS directory

opendir(DIR, "$package_rpms_dir" )
    || croak("Cannot open directory $package_rpms_dir to find RPMs for ODA");
my @package_rpm_files = grep(/\.rpm$/, readdir(DIR));
chomp @package_rpm_files;
closedir DIR;

# Copy the ODA RPMs to the RPM pool (if they're not already there)

foreach my $rpm_file (@package_rpm_files) {
    if (! -e "$oscar_rpms_dir/$rpm_file") {
	oscar_log_subsection("Copying $rpm_file to $oscar_rpms_dir\n");
	copy("$package_rpms_dir/$rpm_file", "$oscar_rpms_dir/$rpm_file") ||
	    croak("Unable to copy $rpm_file to $oscar_rpms_dir");
    }
}

# Now install the "best" version of all the required RPMs if necessary

oscar_log_subsection("Installing ODA RPMs @wanted_rpms");
install_rpms(@wanted_rpms) or 
    croak("ODA is giving up and will not be installed");

# Exit properly so that the exit status gets propogated

oscar_log_subsection("Restarting MySQL server $mysqld");
system("/etc/init.d/$mysqld restart") or croak("Couldn't restart $mysqld");

exit(0);
