#!/bin/sh

### Job name
#PBS -N mpichtest

### Output files
#PBS -o mpichtest.out
#PBS -e mpichtest.err

### Queue name
#PBS -q workq

### Script Commands
cd $PBS_O_WORKDIR
cd ~oscartst/OSCAR_test/mpi
echo "Running MPICH test"

# The MPICH test iteself

NP=`(wc -l < $PBS_NODEFILE) | awk '{print $1}'`

do_cmds() {
    eval $cmds
    if test "$?" != "0"; then
	echo "TEST FAILED!"
	echo "Commands: $cmds"
	exit 1
    fi
}

echo "MPI C bindings test:"
cmds="mpicc cpi.c -o mpich-cpi && mpirun -machinefile $PBS_NODEFILE -np $NP ./mpich-cpi"
do_cmds

echo "MPI C++ bindings test:"
cmds="mpiCC cxxhello.cc -o mpich-cxxhello && mpirun -machinefile $PBS_NODEFILE -np $NP ./mpich-cxxhello"
do_cmds

echo "MPI Fortran bindings test:"
cmds="mpif77 f77hello.f -o mpich-f77hello && mpirun -machinefile $PBS_NODEFILE -np $NP ./mpich-f77hello"
do_cmds

echo "MPICH test complete"
echo "Unless there are errors above, test completed successfully."

echo
exit 0
