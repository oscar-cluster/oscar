#!/bin/sh

### Job name
#PBS -N lamtest

### Output files
#PBS -o lamtest.out
#PBS -e lamtest.err

### Queue name
#PBS -q workq

### Script Commands
cd $PBS_O_WORKDIR
echo "Running LAM/MPI test"

#### BEGIN: This is not necessary in normal PBS LAM scripts ##############
# Users won't need to do this in their normal PBS scripts.  This
# script has to account for the fact that LAM may not be the default
# MPI implementation.  So we have to temporarily make it the user's
# default, run the test, and then switch it back to whatever it was
# before we started.

# If LAM is not set as the user default, temporarily make it so

lam="lam-6.5.6"
user_default_mpi="`switcher mpi --show --user | grep default | cut -d= -f2`"
if test "$user_default_mpi" != "$lam"; then
    switcher mpi --add-attr default $lam --force
fi

# Now ensure that we have LAM loaded here.  Remember that PBS is
# stupid and does not run .files.  So we have to manually setup the
# modules environment.

. /etc/profile.d/00-modules.sh
module unload mpi
module load mpi/$lam
#### END: This is not necessary in normal PBS LAM scripts ################

# This is the test itself.  See?  It's really short.  <sigh>

lamboot $PBS_NODEFILE
pwd
mpicc cpi.c -o lam-cpi
mpirun C lam-cpi
lamclean
lamhalt 

#### BEGIN: This is not necessary in normal PBS LAM scripts ##############
if test "$user_default_mpi" = ""; then
    switcher mpi --rm-attr default --force
else
    switcher mpi --rm-attr default --force
    switcher mpi --add-attr default $lam --force
fi
#### END: This is not necessary in normal PBS LAM scripts ################

echo "LAM/MPI test complete"
echo "Unless there are errors above, test completed successfully."

echo
exit 0
