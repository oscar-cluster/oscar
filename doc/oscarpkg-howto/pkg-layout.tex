% $Id: pkg-layout.tex,v 1.4 2003/09/10 03:31:28 naughtont Exp $

% TJN: Mention the XML tools that are helpful, e.g., 'xmllint'
%      which >= 2.5.8 (i believe) has --schema option too! :)
%      Also, probably want to include the DTD (& Schema) for
%      general perusal/clarity.
 
\section{Package Layout}
\label{sect:pkg-layout}

As OSCAR evolved it became obvious that the mechanism to configure and
install a cluster needed to be cleanly seperated from the software that was
to be installed.  The approach taken was to create \emph{OSCAR Packages}.
The OSCAR Package layout is geared toward making things as simple as
possible for package authors.  So, in its simplest form an OSCAR Package is
an RPM\footnote{A binary RPM compiled for an OSCAR supported Linux
distribution.}.  However, most software requires further configuration for
a cluster environment so additional scripts, documentation, etc. may be
added.  The basic directory structure for an OSCAR Package is as follows.

\begin{quote}
\begin{description}
  \item[\file{config.xml}] -- meta file with description, version, etc.
  \item[\directory{RPMS/}] -- directory containing binary RPM(s) for the package
  \item[\directory{SRPMS/}] -- directory containing source RPM(s) used to build
                            the package
  \item[\directory{scripts/}] --  set of scripts that run at particular times
                     during the installation/configuration of the cluster
  \item[\directory{testing/}] -- unit test scripts for the package
  \item[\directory{doc/}] -- documentation and/or license information
\end{description}
\end{quote}

\noindent For reference purposes, Table~\ref{tab:oscar-envvars}
contains a list of the currently recognized environment variables used by
the OSCAR framework.

% Table with all currently supported/recognized Environment Variables
\input{oscar-envvars-table.tex}

The packaging API provides authors the ability to make use of configuration
scripts to setup cluster software outside of the RPM itself.  The scripts
fire at different stages of the installation process as detailed in
Section~\ref{sect:pkg-scripts}.  The packages may also include simple test
scripts in the \directory{testing/} directory, which are used to verify the
software was properly installed (see Section~\ref{sect:pkg-testing}).
Lastly, an OSCAR Package Downloader (OPD) tool is provided to simplify
acquisition of new packages (see Section~\ref{sect:opd}).




\subsection{\file{config.xml}}
\label{sect:pkg-config-xml}

This XML file provides the package name (\xmltag{name}), version number
(\xmltag{version}) and description information (\xmltag{description}) as
well as the list of RPMS (\xmltag{rpmlist}) and their installation location
(e.g., ``oscar\_server'', ``oscar\_clients'').   The file enables an author
to convey constraints such as supported distribution (\xmltag{filter}) or
simple dependencies (\xmltag{requires}) upon other OSCAR Packages, e.g.,
Env-Switcher.  If this meta file is not included a simplistic default is
used---install all files in \directory{RPMS/} on all machines in cluster.
The available XML elements for use in this file are listed in
Table~\ref{tab:pkg-xml-tags} with a complete example given in
Section~\ref{sect:example-pkg}.

The \xmltag{rpmlist} contains the list of RPM names (without version
numbers) to be installed for the package.  There may be multiple instances
of these \xmltag{rpmlist}'s using the \xmltag{filter} to differentiat where
necessary.  The \xmltag{filter} constraints enable an author to express
what \xmlattr{distribution}, \xmlattr{distribution\_version} and
\xmlattr{arch} the associated \xmltag{rpm}'s support.  The \xmlattr{group}
value specifies where the to install the \xmltag{rpm}'s.   Things are
implicitly global if no constraints are provided, i.e., entire cluster for
all distributions.

% Table with all currently supported XML tags & brief description
\input{pkg-xml-table.tex}


\subsection{RPMS \& SRPMS}
\label{sect:pkg-rpms-srpms}

The pre-compiled binary version of the software is provided in RPM format.
The RPMS are placed, obviously enough, in the \directory{RPMS} directory.
The OSCAR Wizard copies all files listed in the \xmltag{rpmlist} from this
\directory{RPMS} directory to the \directory{/tftpboot/rpm} directory or
alternately the directory specified by the environment variable
\envvar{OSCAR\_RPMPOOL}.   The exact \xmltag{rpmlist} that is processed is
deterimined based upon the the \xmltag{filter} that is entirely true and
most particular.  The list of supported distributions for each OSCAR
release is typically stored in Table 1 of the installation document.

%I don't believe there's any need for this b/c the only instance it would
% matter is when we're honoring the subdir='X' value (i.e., getting data 
% from the <filter> that would be modify the operation of the <rpm>
% as opposed to simply determining whether or not the <rpmlist> matches
% which is all the <filter>'s do if there is no subdir='X' attr.
%\begin{verbatim}
%     1    <rpmlist>
%     2        <filter distribution='redhat' subdir='rh'/>
%     3        <filter distribution='redhat' arch='ia64' subdir='rh-ia64' />
%     4        <rpm>foobar</rpm>
%     5        <rpm>baz</rpm>
%     6    </rpmlist>
%\end{verbatim}

\begin{verse}
   {\bfseries Notice: } As of OSCAR-2.3 the \xmltag{filter} tag does not yet
   support the \xmlattr{subdir} attribute, which is used to specify a
   directory for the \xmltag{rpm}'s in the \xmltag{rpmlist}.  Due to this
   limitation, some packages use a \file{setup} script to copy the
   appropriate RPMS to this \directory{RPMS} area based on the value
   returned from Perl method \verb=OSCAR::Distro::which_distro_server()=.
   To access this method from your \file{scripts/setup} file add the
   includes: 
   \begin{verbatim}
           use lib "$ENV{OSCAR_HOME}/lib";
           use OSCAR::Distro;
   \end{verbatim}
\end{verse}




% TJN: finish this section
\subsection{scripts}
\label{sect:pkg-scripts}

The configuration of a particular package 
The currently available API scripts are listed in Table~\ref{tab:pkg-scripts}.
% Table with all currently supported API script & brief description.
\input{pkg-scripts-table.tex}


\subsubsection{Configurator}
\label{sect:pkg-configurator}

Packages are obtain user input via a simple facility called the
``Configurator''.  The package author writes a simple HTML Form style
document that is presented to the user if the package is selected for
installation.  The standard multi-pick lists, radio button, checkbox fields
are available.  Typically default values are provided to simplify matters
where possible for users.  A full discussion is provided in the ``Config-HOWTO.html'' 
document found in the documentation area of the OSCAR developer CVS tree.

To make use of this facility create a file in the top-level of the
package's directory called \file{configurator.html}.  After the package
selection phase of the OSCAR Wizard all packages containing this file are
processed by the Configurator.  The results of this processing are written
out in XML format to the top-level directory of the package in a file
called \file{.configurator.values}.  At this point the
\file{post\_configure} API scripts are fired so packages may read the
results of the configuration phase.    The Perl \file{XML::Simple} module
is typically used for processing these results in conjuntion with the
\envvar{OSCAR\_PACKAGE\_HOME} environment variable.  See
Section~\ref{sect:example-configurator} for an example of the input and
a simple processing script.



% TJN: finish this section
\subsection{testing}
\label{sect:pkg-testing}

Basic tests are run for each package.  The two scripts that are available
for this testing are: \file{test\_root} and \file{test\_user}.  When tests
are run for the cluster, all \file{test\_root} scripts are sourced which
perform any root level package tests.  

\begin{verse}
   {\bfseries Notice: } There are obvious security issues with this
   but currently all operations in the cluster installation are being
   performed by {\tt root} so care is expected at all phases.  The user
   tests are run as an actual user so those tests are somewhat less 
   dangerous and therefore most packages are using \file{test\_user}.
\end{verse}


The tests typically have PBS available and most of teh \file{test\_user}
scripts simply setup and run a simple PBS jobs for the installed software,
e.g., PVM, MPI's.  The testing framework is currently pretty simple with
display functions provided which show boolean results of ``PASSED'' or
``FAILED''.




 
\subsection{doc}
\label{sect:pkg-doc}

This directory contains supplemental documentation for the package.  There
are a few pre-defined \LaTeX\ files that may be incorporated into the
overall OSCAR documentation if the package's classification is either
\emph{core} or \emph{selected}~\footnote{That is to say the package is
included in the main distribution tarball -- not obtained via OPD.}.  These
files are: \file{install.tex}, \file{user.tex} and \file{license.tex}.  The
first is added to the overall \file{install.pdf} and contains information
related to the installation of the particular software package.  The latter
two files are incorporated into the \file{user.pdf}.   The user information
can be complete or simply pointers to obtaining more thorough documentation
for the particular package.  The license for all packages are listed in
this document based on the contents of this \file{license.tex} file.


