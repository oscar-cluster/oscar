% -*- latex -*-
%
% $Id: troubleshooting.tex,v 1.8 2002/02/06 01:43:34 bwbarrett Exp $
%
% $COPYRIGHT$
%

\section{Troubleshooting}
\label{app:troubleshooting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Using LAM/MPI Instead of MPICH}

Both LAM/MPI and MPICH are installed on all nodes in an OSCAR cluster.
As of OSCAR version \oscarversion, MPICH is the default MPI
implementation for all users.  LAM/MPI can be made the default for all
users, or on a user-by-user basis.

Scripts in the \file{/etc/profile.d} directory add both LAM/MPI and
MPICH to each user's environment.  Scripts in this directory are
executed in sorted order.  Four scripts in particular are relevant:

\begin{verbatim}
  /etc/profile.d/mpi-00mpich.sh
  /etc/profile.d/mpi-00mpich.csh
  /etc/profile.d/mpi-01lam.sh
  /etc/profile.d/mpi-01lam.csh
\end{verbatim}

Each script adds the respective MPI implementation to the user's
environment by appending a directory to the end of the user's path.
Since the MPICH scripts are run before the LAM scripts, the MPICH
\file{bin} directory is added to the user's path before the LAM
\file{bin} directory.  Hence, the MPICH binaries are found before the
LAM binaries.  For example, in the \cmd{bash} shell, the command:

\begin{verbatim}
  % which mpirun
\end{verbatim}

\noindent will show the path for the MPICH \cmd{mpirun}.

Please note that future versions of OSCAR will make the process of
switching between LAM/MPI and MPICH (for all users and for individual
users) much simpler.

\subsubsection{Making LAM/MPI the Default for All Users}

To set the default environment for all users to use LAM/MPI instead of
MPICH, either delete the \file{mpi\-00mpich*} files, or rename them to
have a number higher than \file{01} so that they will be executed
after the LAM script.  For example:

\begin{verbatim}
  % cd /etc/profile.d
  % mv mpi-00mpich.sh mpi-05mpich.sh
  % mv mpi-00mpich.csh mpi-05mpich.csh
\end{verbatim}

\subsubsection{Making LAM/MPI the Default for an Individual User}

If inidividual users want to use LAM/MPI instead of MPICH, they should
edit their shell-setup file to invoke the LAM \file{profile.d} setup
script before all the other \file{/etc/profile.d} scripts.  For
example, \cmd{bash} users can typically edit their \file{.bashrc} file
to add the following line before \file{/etc/bashrc} is invoked:

\begin{verbatim}
  . /etc/profile.d/mpi-01lam.sh
\end{verbatim}

Similarly, \file{csh}-style shell users can \cmd{source} the
\file{mpi-01lam.csh} script in their \file{.cshrc} file.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Managing machines and images}
\label{app:troubleshooting-machines-images}
During the life of your cluster, you may want to delete unused machines
or images, create new images, or change the image that a client uses.
Currently OSCAR doesn't have a direct interface to do this, but you can use
the SIS commands directly. Here are some useful examples:
\begin{itemize}
\item To list all defined machines, run:
\begin{verbatim}
        mksimachine --List
\end{verbatim}
\item To list all defined images, run:
\begin{verbatim}
        mksiimage --List
\end{verbatim}
\item To delete an image, run:
\begin{verbatim}
        mksiimage --Delete --name <imagename>
\end{verbatim}
\item To delete a machine, run:
\begin{verbatim}
        mksimachine --Delete --name <machinename>
\end{verbatim}
\item To delete all machines, run:
\begin{verbatim}
        mksimachine --Delete --all
\end{verbatim}
\item To change which image a machine will install, run:
\begin{verbatim}
        mksimachine --Update --name <machinename> --image <imagename>
\end{verbatim}
\end{itemize}

There is also a SIS gui that is availble. Start it by running \file{tksis}. It 
doesn't yet support the update function, but it can make the other operations
easier.

More details on these commands can be obtained from their respective man
pages.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Known Problems and Solutions}
\label{app:troubleshooting-known-problems}

\subsubsection{Client nodes fail to network boot}
\label{app:troubleshooting-known-problems-dhcp}

There are two causes to this problem. The first is that the DHCP
server is not running on the server machine, which probably means the
\file{/etc/dhcpd.conf} file format is invalid. Check to see if it is
running by running the command ``\cmd{service dhcpd status}'' in the
terminal.  If no output is returned, the DHCP server is not running.
See the problem solution for ``DHCP server not running'' below. If the
DHCP server is running, the client probably timed out when trying to
download its configuration file. This may happen when a client is
requesting files from the server while multiple installs are taking
place on other clients. If this is the case, just try the network boot
again when the server is less busy. Occasionally, restarting the inet
daemon also helps with this problem as it forces tftp to restart as
well. To restart the daemon, issue the following command:

\begin{verbatim}
  service xinetd restart
\end{verbatim}

\subsubsection{DHCP server not running}

Run the command ``\cmd{service dhcpd start}'' from the terminal and
observe the output. If there are error messages, the DHCP
configuration is probably invalid. A few common errors are documented
below. For other error messages, see the \file{dhcpd.conf} man page.

\begin{enumerate}
\item If the error message produced reads something like
  ``\msgout{Can't open lease database}'', you need to manually create
  the DHCP leases database, \file{/var/lib/dhcp/dhcpd.leases}, by
  issuing the following command in a terminal:

\begin{verbatim}
  touch /var/lib/dhcp/dhcpd.leases
\end{verbatim}
  
\item If the error message produced reads something like ``\msg{Please
    write a subnet declaration for the network segment to which
    interface ethx is attached}'', you need to manually edit the DHCP
  configuration file, \file{/etc/dhcpd.conf}, in order to try to get
  it valid. A valid configuration file will have at least one subnet
  stanza for each of your network adapters. To fix this, enter an
  empty stanza for the interface mentioned in the error message, which
  should look like the following:

\begin{verbatim}
  subnet subnet-number netmask subnet-mask { }
\end{verbatim}
  
  The subnet number and netmask you should use in the above command
  are the one's associated with the network interface mentioned in the
  error message.
\end{enumerate}

\subsubsection{PBS is not working}

The PBS configuration done by OSCAR did not complete successfully and
requires some manual tweaking. Issue the following commands to
configure the server and scheduler:

\begchange
% We have to use \tt instead of {verbatim} because we need to use
% \oscarversion inside.  This makes it somewhat painful -- much less
% easy than {verbatim}.
\vspace{11pt}
{\tt
  service pbs\_server start \\
\indent  service maui start \\
\indent  cd /root/oscar-\oscarversion/pbs/config \\
\indent  /usr/local/pbs/bin/qmgr < pbs\_server.conf
}
\vspace{11pt}

Replace ``\file{/root}'' with the directory into which you unpacked
\endchange
OSCAR in the change directory command above.

\subsubsection{Uni-processor P4 nodes fail to boot}
\begchange
This problem has occured on some newer machines after the 'oscar\_wizard' 
has run and the nodes have rsync'd their files to the local harddrive. 
The nodes then restart and begin to boot the newly installed kernel
and hang with a message similar to the following,
\begin{verbatim}
       Getting VERSION: 0
       Getting VERSION: ff00ff
       enabled ExtINT on CPU#0
       ESR value before enabling vector: 00000000
       ESR value after enabling vector: 00000000
       calibrating APIC timer ...
       ..... CPU clock speed is 1995.0407 Mhz.
       ..... host bus clock speed is 0.0000 Mhz.
       cpu: 0, clocks: 0, slice: 0
       _
\end{verbatim}
The cursur just blinks here forever.

This problem occurs because the SMP kernel is installed and the
machine needs a standard uni-processor kernel.  Most machines will boot
normally with the SMP kernel but a small number exhibit this issue.
Currently, the simplest fix is to rebuild the image with the
uni-processor kernel (e.g. \emph{kernel-2.4.2-2}) in the rpmlist 
(e.g. \emph{oscarsamples/sample.rpmlist}) and re-install the failing node.  

We are currently investigating the problem further.  If you are experiencing 
this problem, please check the OSCAR web page at
{\tt http://oscar.sourceforge.net/} for the latest information and solutions
to this problem.

%%%A workable fix for this would be to do the following steps to
%%%install the uni-processor kernel (\emph{kernel-2.4.2-2.i386.rpm}) into 
%%%an existing image named \emph{oscarimage}.  After that you can repeat
%%%the installation of the nodes, using either network boot (PXE) or a
%%%boot floppy.   This will do a complete re-install of the node.
%%%\begin{verbatim}
%%%       [root@oscar /root]# cp /tftpboot/rpm/kernel-2.4.2-2.i386.rpm \
%%%       /var/lib/systemimager/images/oscarimage/tmp
%%%       [root@oscar /root]# chroot /var/lib/systemimager/oscarimage
%%%       [root@oscar /]# rpm -ivh /tmp/kernel-2.4.2-2.i386.rpm 
%%%       [root@oscar /]# rm /tmp/kernel-2.4.2-2.i386.rpm
%%%       [root@oscar /]# cd boot
%%%       [root@oscar boot]# ln -sf kernel.h-2.4.2  kernel.h
%%%       [root@oscar boot]# ln -sf module-info-2.4.2-2  module-info
%%%       [root@oscar boot]# ln -sf System.map-2.4.2-2  System.map
%%%       [root@oscar boot]# ln -sf vmlinuz-2.4.2-2  vmlinuz
%%%       [root@oscar /]# exit
%%%       [root@oscar /root]#
%%%\end{verbatim}
% extra dir listing i took out of the above.
%       [root@oscar boot]# ls *2.4.2*
%       kernel.h-2.4.2          System.map-2.4.2-2     vmlinux-2.4.2-2smp
%       module-info-2.4.2-2     System.map-2.4.2-2smp  vmlinuz-2.4.2-2
%       module-info-2.4.2-2smp  vmlinux-2.4.2-2        vmlinuz-2.4.2-2smp
%Now, you need backup and edit the \emph{oscarimage.master} script so
%that it skips the partitioning of the disk and just goes onto the
%rsync'ing of the files.  NOTE: THIS IS THE SECTION THAT I NEED TO 
%FINISH UP B/C I'VE NOT TESTED IT YET ... THEREFORE I'M NOT GOING TO
%INCLUDE IT HERE.
\endchange



\subsection{What to do about unknown problems?}

For help in solving problems not covered by this HowTo, send a
detailed message describing the problem to the OSCAR users mailing
list at \email{oscar-users@lists.sourceforge.net}. You may also wish
to visit the OSCAR web site, \url{http://oscar.sourceforge.net}, for
updates on newly found and resolved problems.

\subsection{Starting Over or Uninstalling OSCAR}

If you feel that you want to start the cluster installation process
over from scratch in order to recover from irresolvable errors, you
can do so with the \file{start\_over} script located in the
\file{scripts} subdirectory. This script is interactive, and will
prompt you when removing components installed by OSCAR that you may
not want to remove.

If you would like to remove all traces of OSCAR from your server, you
may do so by running the \file{uninstall} script located in the
\file{scripts} subdirectory. This will run the \file{start\_over}
script and then remove the OSCAR directory created by unpacking the
tarball, but does not remove the tarball itself.


% LocalWords:  Exp
