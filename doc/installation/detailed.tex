% -*- latex -*-
%
% $Id: detailed.tex,v 1.6 2001/12/17 05:52:04 mchasal Exp $
%
% $COPYRIGHT$
%

\section{Detailed Cluster Installation Procedure}

Note: All actions specified herein should be performed by the
\user{root} user.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Server Installation and Configuration}
  
During this phase, you will prepare the machine to be used as the
server for using OSCAR.

\subsubsection{Install Linux on the server machine} 

If you have a machine you want to use that already has Linux
installed, you may use it and continue with the next section. When installing
Linux, it is required that you use a distribution that is based upon
the RPM standard.  Furthermore, it should be noted that all testing up
to this point has been done using the Red Hat 7.1 distribution. As
such, use of distributions other than Red Hat 7.1 will require a
porting of OSCAR, as many of the scripts and software within OSCAR are
dependent on Red Hat. Do not worry about doing a custom install, as
OSCAR contains all the software on which it depends.  The only other
installation requirement is that some X environment such as GNOME or
KDE must be installed. Therefore, a typical workstation install is
sufficient.

\begchange
If you install Red Hat 7.1 on the server machine, during the
installation you should enable the ipchains-base firewall that is 
included with the Red Hat distribution in medium mode.
Other firewalls that are stronger and more versatile can be installed
later, but this will offer some protection until that time.
Note that OSCAR currently assumes that only the server machine is
exposed to the general network, with the server and the rest of the
cluster's machines being on a private network. To keep the Red Hat
firewall from interfering with network traffic between the server
machine and the other machines in the cluster, OSCAR automatically
disables portions of the Red Hat firewall. This may not have the
intended results in the situation where all the cluster machines
are exposed on the general network.
See Appendix~\ref{app:security} for more information about firewalls
and other security software that can be installed. 
\endchange

\subsubsection{Disk space and directory considerations}

OSCAR has certain requirements for server disk space. Space will be
needed to store the Linux rpms and to store the images.
The rpms will be stored in /tftpboot/rpm. Approximately 1 gigabyte is required
to store the rpms. 
The images are stored in /var/lib/systemimager and will need approximately
1 gigabyte per image. Only 1 image is required, although you may want to create
more in the future. 

If you are installing a new server, it is suggested that you allow for 
2 gigabytes in both the \file{/}, which contains \file{/tftpboot},  
and \file{/var} filesystems when partitioning the disk on your server.

If you are using an existing server, you will need to verify that you have 
enough space on the disk partitions. Again 2 gigabytes of free space
is recommended in both the \file{/} and \file{/var} partitions.

You can check
the amount of free space on your drive's partitions by issuing the
command \cmd{df -h} in a terminal.  The result for each file system is
located below the \panel{Avail} heading. If your root (\file{/})
partition has enough free space, enter the following command in a
terminal:

\begin{verbatim}
  mkdir -p /tftpboot/rpm
\end{verbatim}
  
If your root partition does not have enough free space, create the
directories on a different partition that does have enough free space
and create links to them from the root (\file{/}) directory.  For
example, if the partition containing \file{/usr} contains enough
space, you could do so by using the following commands:

\begin{verbatim}
  mkdir -p /usr/tftpboot/rpm
  ln -s /usr/tftpboot /tftpboot
\end{verbatim}

The same procedure should be repeated for the \file{/var/lib/systemimager}
subdirectory.

    
\subsubsection{Get a copy of OSCAR and unpack on the server} 

If you are reading this, you probably already have a copy. If not, go
to \url{http://oscar.sourceforge.net/} and download the latest OSCAR
tarball, which will be named something like \file{ oscar-version.tgz}.
The version used in these instructions is \oscarversion, which you
should replace with the version you download in any of the sample
\begchange
commands. Copy the OSCAR tarball to a directory such as \file{/root} on
\endchange
your server. There is no required installation directory, except that
you may not use \file{/usr/local/oscar}, which is reserved for special
use. Do {\bf not} unpack the tarball on a Windows based machine and
copy the directories over to the server, as this will convert all the
scripts to the dreaded ``DOS'' format and will render them useless
under Linux.  Assuming you placed the OSCAR tarball in
\begchange
\file{/root},
\endchange
open a command terminal and issue the following commands to unpack
OSCAR:

\begchange
\begin{verbatim}
  cd /root
  tar -zxvf oscar-<VERSION>.tgz
\end{verbatim}
\endchange
    
The result is the creation of an OSCAR directory structure that is
laid out as show in Table~\ref{tab:oscar-dir-struct} (again assuming
\begchange
\file{/root}).
\endchange

\begchange
\begin{table}[htbp]
  \begin{center}
    \begin{tabular}{|l|p{3in}|}
      \hline
      \multicolumn{1}{|c|}{Directory} &
      \multicolumn{1}{|c|}{Contents} \\
      \hline
      \hline
      \file{/root/OSCAR-\oscarversion/} & the base OSCAR directory \\
%
      \file{/root/OSCAR-\oscarversion/COPYING} & GNU General Public License
      v2 \\
%
      \file{/root/OSCAR-\oscarversion/README.first} & README first document \\
%
      \file{/root/OSCAR-\oscarversion/c3} & contains files for C3
      installation \\
%
      \file{/root/OSCAR-\oscarversion/docs} & OSCAR documentation directory \\
%
      \file{/root/OSCAR-\oscarversion/install\_cluster} & main installation
      script \\
%
      \file{/root/OSCAR-\oscarversion/lui} & contains files for LUI
      installation \\
%
      \file{/root/OSCAR-\oscarversion/oscarResources} & contains sample OSCAR
      resources \\
%
      \file{/root/OSCAR-\oscarversion/oscarRPM} & contains RPMs for software
      installed \\
%
      \file{/root/OSCAR-\oscarversion/pbs} & contains files for PBS
      installation \\
%
      \file{/root/OSCAR-\oscarversion/prog\_env} & contains files for MPI and
      PVM installations \\
%
      \file{/root/OSCAR-\oscarversion/scripts} & contains scripts that do most
      of the work \\
%
      \file{/root/OSCAR-\oscarversion/systemimager} & contains files for
      SystemImager installation \\
%
      \file{/root/OSCAR-\oscarversion/testing} & contains OSCAR Cluster Test
      software \\
      \hline
    \end{tabular}
    \caption{OSCAR file directory layout.}
    \label{tab:oscar-dir-struct}
  \end{center}
\end{table}
\endchange
  
\subsubsection{Configure the ethernet adapter for the cluster} 

Assuming you want your server to be connected to both an external
network and the internal cluster subnet, you will need to have two
ethernet adapters installed in the server. It is preferred that you do
this because exposing your cluster may be a security risk, and certain
software used in OSCAR such as DHCP may conflict with your external
network.  Once both adapters have been physically installed and you
have booted Linux into an X environment, open a terminal and enter the
command:

\begin{verbatim}
  /usr/sbin/netcfg &
\end{verbatim}
  
The network configuration utility will be started, which you will use
to configure your network adapters.
  
At this point, the \panel{Names} panel will be active. On this panel
you will find the settings for the server's hostname, domain,
additional search domains, and name servers. All of this information
should have been filled in by the standard Linux installation. To
configure your ethernet adapters, you will need to first press the
\button{Interfaces} button to bring up the panel that allows you to
update the configuration of all of your server machines interfaces.
You should now select the interface that is connected to the cluster
network by clicking on the appropriate device. If your external
adapter is configured on device ``\file{eth0}'', then you should most
likely select ``\file{eth1}'' as the device, assuming you have no
other adapters installed. After selecting the appropriate interface,
press the \button{Edit} button to update the information for the
cluster network adapter. Enter a private IP address
\begchange
\footnote
{
  There are
  three private IP address ranges: 10.0.0.0 to 10.255.255.255;
  172.16.0.0 to 172.32.255.255; and 192.168.0.0 to 192.168.255.255.
  Additional information on private intranets is available in RFC
  1918.
  You should not use the IP addresses 10.0.0.0 or 172.16.0.0 or 
  192.168.0.0 for the server.  If you use one of these addresses 
  the network installs of the client nodes will fail (rpc has 
  problems).
}
\endchange
and the associated netmask\footnote{The netmask
  255.255.255.0 should be sufficient for most OSCAR clusters.}  in
their respective fields. Additionally, you should be sure to press the
\button{Activate interface at boot time} button and set the
\button{Interface configuration protocol} to ``none''.  After
completing the updates, press the \button{Done} button to return to
the main utility window,
\begchange
pressing the \button{Save} button in the Save current configuration
menu that pops up.
\endchange
Then press the \button{Save} button at the bottom of the main network
configuration window to confirm your changes, and then press the
\button{Quit} to leave the network configuration utility.
  
Now reboot your machine to ensure that all the changes are propagated
to the appropriate configuration files. To confirm that all ethernet
adapters are in the \msg{UP} state, once the machine has rebooted,
open another terminal window and enter the following command:

\begin{verbatim}
  /sbin/ifconfig -a
\end{verbatim}
  
You should see \msg{UP} as the first word on the third line of output
for each adapter. If not, there is a problem that you need to resolve
before continuing. Typically, the problem is that the wrong module is
specified for the given device. Try using the network configuration
utility again to resolve the problem.
  
\subsubsection{Copy distribution RPMs to \file{/tftpboot/rpm}}

In this step, you need to copy the RPMs included with your Linux
distribution into the \file{/tftpboot/rpm} directory. 
\begchange
Insert each of the distribution CDs in turn.
When each one is inserted, linux will automatically make the
contents of the CD be available in the \file{/mnt/cdrom} directory.
Then for each CD locate the directory that contains the RPMs.
In Red Hat 7.1, the RPMs are located in the \file{RedHat/RPMS}
directory, which will appear on the system as the 
\file{/mnt/cdrom/RedHat/RPMS} directory. 
\endchange
 After locating the RPMs on the each CD, copy them into
\file{/tftpboot/rpm} with a command such as:

\begin{verbatim}
  cp /mnt/cdrom/RedHat/RPMS/*.rpm /tftpboot/rpm
\end{verbatim}
  
Be sure to repeat the above process for both CDs when using Red Hat
7.1.
\begchange
After using each CD you will have to unmount it from the local
file system by issuing these commands:

\begin{verbatim}
  cd
  umount /mnt/cdrom
\end{verbatim}
\endchange
If you wish to save space on your server's hard drive and will be
using the default RPM list supplied with OSCAR (see
Section~\ref{sec:detailed-cluster-def},
you should only copy over the RPMs listed in the sample.
\begchange
For the Red Hat 7.1 distribution, this can be done for each CD with
a command sequence like this:

\begin{verbatim}
  cd /mnt/cdrom/RedHat/RPMS
  cat /root/OSCAR-\oscarversion/oscarsamples/sample.rpmlist | \
  xargs -i sh -c "cd `pwd`;ls -1 {}*.rpm" 2>/dev/null | \
  xargs -i -t cp -f '{}' /tftpboot/rpm
\end{verbatim}

\endchange

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  
\subsection{Initial OSCAR Server Configuration}

During this phase, the software needed to run OSCAR will be installed
on the server. In addition, some initial server configuration will be
performed. The steps from here forward should be run within the X
environment, due to the graphical nature of the OSCAR.

\subsubsection{Change to the OSCAR directory and run \file{install\_cluster}}

\begchange
If the OSCAR directory was placed in \file{/root} for example, you
would issue the following commands:

\begin{verbatim}
  cd /root/OSCAR-\oscarversion
  ./install_cluster eth0
\end{verbatim}
\endchange
  
\begchange
In the above command, substitute the device name 
\endchange
(e.g., \file{eth0})
for your server's internal ethernet adapter. Also note that the
\file{install\_cluster} script must be run from within the OSCAR base
directory as shown above. The script will first run the part one
server configuration script, which does the following:

\begin{enumerate}
\item copies Oscar rpms to /tftpboot/rpm
\item installs all server Oscar rpms
\item updates \file{/etc/hosts} with OSCAR aliases
\item updates \file{/etc/exports} 
\item adds Oscar paths to \file{/etc/profile} 
\item updates system startup (\file{/etc/rc.d/init.d}) scripts
\item restarts affected services
\end{enumerate}
  
If the part one script finishes successfully, \file{install\_cluster}
will then start the OSCAR wizard. The wizard, as shown in
Figure~\ref{fig:detailed-oscar-wizard}, is provided to guide you
through the rest of the cluster installation.  To use the wizard, you
will complete a series of steps, with each step being initiated by the
pressing of a button on the wizard. Do not go on to the next step
until the instructions say to do so, as there are times when you must
complete an action outside of the wizard before continuing on with the
next step. For each step, there is also a \button{Help} button located
directly to the right of the step button. When pressed, the
\button{Help} button displays a message box describing the purpose of
the step.

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[scale=\imgscale]{oscar-wizard.\figext}
    \caption{OSCAR Wizard.}
    \label{fig:detailed-oscar-wizard}
  \end{center}
\end{figure}
  
As each of the steps are performed, there is output generated that is
displayed to the user. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Cluster Definition}
\label{sec:detailed-cluster-def}

During this phase, you will complete steps one through five of the
OSCAR wizard in defining your cluster. If you encounter problems or
wish to redo any of the SIS actions performed in the wizard steps 1,
or 2, please refer to the SIS man pages.

\subsubsection{Build the Image} 

Press the Step 1 button of the wizard entitled \button{Build the OSCAR
client image}. A dialog will be displayed. In most cases, the defaults 
will be sufficient. You should verify that the disk partition file is
the proper type for your client nodes disks. The sample files have the
disk type as the last part of the filename. You may also want to change
the post installation action and the IP assignment methods.
\msg{It is important to note that if you wish to
  use automatic reboot, you should make sure the BIOS on each client
  is set to boot from the local hard drive before attempting a network
  boot by default. If you have to change the boot order to do a
  network boot before a disk boot to install your client machines, you
  should not use automatic reboot.} 
Once you are satisfied with the input, click the \button{Build Image} button.

Building the image will take a few minutes, the progress bar on the bottom 
will give you the status and a small dialog will appear when the image
is complete.
  
A sample dialog with input and successful output is
shown in Figure~\ref{fig:detailed-build-image}. 

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[scale=\imgscale]{build-image.\figext}
    \caption{Build the image.}
    \label{fig:detailed-build-image}
  \end{center}
\end{figure}
  
\paragraph{Customizing your image}

The defaults of this panel use the sample disk partition and rpm package files
that can be found in the \file{oscarsamples} directory.
At some point, you may want to customize these files to make the image
suit your particular requirements.

\subparagraph{Disk partitioning}

The disk partition file has the following format:

\subparagraph{Package lists}
The package list is simply a list of rpm file names, 1
per line. Be sure and include all of the prerequisites that
any packages you might add have. You do not need to specify
the architecture portion of the filename, nor do you need 
to specify the version. The highest version that matches the
portion that you specify will be used.

\subsubsection{Define your client machines} 

Press the Step 2 button of the wizard entitled \button{Define OSCAR
 Clients}. In the dialog box that is displayed, enter the
appropriate information. Again the defaults will be correct in most
cases. At a minumum, you will need to enter the number of clients that you want
to create.

\begin{enumerate}

\item The \field{Image Name} field should specify the image name that was used to 
create the image in Step 1.

\item The \field{Domain Name} field should be used to specify the client's IP
domain name.

\item The \field{Base name} field is used to specify the first part of the 
client name and hostname. It will have an index appended to the end of it.

\item The \field{Number of Hosts} field specifys how many clients to create.

\item The \field{Starting Number} specifies the index to append
to the \field{Base Name} to derive the first client name. It will be incremented
for each subsequent client.

\item The \field{Starting IP} specifies the IP address of the first client. It 
will be incremented for each subsequent client.

\item The \field{Subnet Mask} specifies the IP netmask for the clients.

\item The \field{Default Gateway} specifies the default route for the clients.

\end{enumerate}
  
When finished entering information, press the \button{Add Clients} button.
A sample dialog with input and output is shown in
Figure~\ref{fig:detailed-define-clients}. After the clients are created,
a dialog will pop up with the completion status. After closing that 
you may press the \button{Close}
button and continue with the next step.

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[scale=\imgscale]{define-clients.\figext}
    \caption{Define the Clients.}
    \label{fig:detailed-define-clients}
  \end{center}
\end{figure}
    
\subsubsection{Collect client MAC addresses and Setup Networking} 

The MAC address of a client
is a twelve hex-digit hardware address embedded in the client's
ethernet adapter. MAC addresses look like 00:0A:CC:01:02:03, as
opposed to the familiar format of IP addresses. These MAC addresses
uniquely identify client machines on a network before they are
assigned IP addresses. DHCP uses the MAC address to assign IP 
addresses to the clients.

In order to collect the MAC addresses,  press the Step 3 button
  of the wizard entitled \button{Setup Networking}. The
  OSCAR network utility dialog box will be displayed.
  To start the collection, press the \button{Start Collecting} button and then
  network boot the first client.  As the clients broadcast, their MAC addresses
  will show up in the left hand window. Select a MAC address and the appropriate
  client in the right side window. Click \button{Assign MAC to node} to 
  associate that MAC address with that node. If you would like to make 
  specific nodes associated with specific client definitions, you should
  boot them one at a time. If you don't care which node gets associated
  with which client, you may boot them all at once and randomly assign
  the MAC addresses.

  When you have collected all of the MAC addresses, click the \button{Stop Collecting}
  button and then click the \button{Setup DHCP Server} button to configure it.

  In order to use this tool, you will need to know
  how to network boot your client nodes.  For instructions on doing
  so, see Appendix~\ref{app:net-boot-client-nodes}. A sample dialog
  that has been used to collect four client MAC addresses is shown in
  Figure~\ref{fig:detailed-collect-mac}. 
 
  You may also configure your remote boot method from this panel. The
  \button{Build Autoinstall Floppy} button will build a boot floppy for
  client nodes that do not support PXE booting. The \button{Setup Network 
  Boot} button will configure the server to answer PXE boot requests if
  your client hardware supports it. See Appendix~\ref{app:net-boot-client-nodes}
  for more details.
  When you have collected the
  addresses for all your client nodes, and completed the networks setup
  press \button{Done}.

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[scale=\imgscale]{collect-mac.\figext}
    \caption{Collect client MAC addresses.}
    \label{fig:detailed-collect-mac}
  \end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Client Installations}

During this phase, you will network boot your client nodes and they
will automatically be installed and configured as specified in
Section~\ref{sec:detailed-cluster-def} above. For a detailed
explanation of what happens during client installation, see
Appendix~\ref{app:client-install}.

\subsubsection{Network boot the client nodes}

See Appendix~\ref{app:net-boot-client-nodes} for instructions on
network booting clients.

\subsubsection{Check completion status of nodes}

After a few minutes, the clients should complete the installation.
You can watch the client consoles to monitor the progress. Depending
on the Post Installation Action you selected when building the image,
the clients will either halt, reboot or beep incessantly when the 
installation is completed. 
The time required for installation deepends on the capabilities of
your server, your clients, your network, and the number of simultaneous 
client installations, it should complete within a few minutes.
  
\subsubsection{Reboot the client nodes}

After confirming that a client has completed its installation, you
should reboot the node from its hard drive. If you chose to have your
clients reboot after installation, they will do this on their
own. If the clients are not set to reboot, you must manually
reboot them. The filesystems will have been unmounted so it is safe
to simply reset or power cycle them.
 \msg{Note: If you had to change the BIOS boot
  order on the client to do a network boot before booting from the
  local disk, you will need to reset the order to prevent the node
  from trying to do another network install.}

\subsubsection{Check network connectivity to client nodes}

In order to perform the final cluster configuration, the server must
be able to communicate with the client nodes over the network. If a
client's ethernet adapter is not properly configured upon boot,
however, the server will not be able to communicate with the client. A
quick and easy way to confirm network connectivity is to do the
\begchange
following (assuming OSCAR installed in \file{/root}):

\begin{verbatim}
  cd /root/OSCAR-\oscarversion/scripts
  ./ping_clients
\end{verbatim}
\endchange

The above commands will run the \cmd{ping\_clients} script, which will
attempt to ping each defined client and will print a message stating
success or failure. If a client cannot be pinged, the initial ramdisk
provided probably did not have built in module support for its
ethernet adapter, and you will have to log in to the machine and
manually configure the adapter. Once all the clients have been
installed, rebooted, and their network connections have been
confirmed, you may proceed with the next step.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Cluster Configuration}

During this phase, the server and clients will be configured to work
together as a cluster.

\subsubsection{Complete the cluster configuration}

Press the Step 4 button of the wizard entitled \button{Complete
 Cluster Setup}.  This will run the \file{post\_install} script,
which does the following:

\begin{enumerate}
\item Queries number of processors from the client nodes.
  
\end{enumerate}

  Note that any users created on the server after the OSCAR
  installation will not be in the password/group files of the clients
  until they have been synced with the server - you can accomplish
  this using the C3 \cmd{cpush} tool.


\subsubsection{Test your cluster using the OSCAR Cluster Test
  software}
            
Provided along with OSCAR is a simple test to make sure the key
cluster components (PBS, MPI, and PVM) are functioning properly. 

Press the Step 5 button of the wizard entitled \button{Test
 Cluster Setup}. This will open a window that will test 
 the server services and then ask for a non-root user to use for the
 testing. Once the test setup completes do the following steps:
\begin{enumerate}
 \item open another terminal 
 \item login as the user you gave in the setup
 \item change to the \file{OSCAR\_test} directory
 \item run the \file{test\_cluster} script, answering the questions
 that are asked.
\end{enumerate}

\subsubsection{Congratulations!!}

Your cluster setup is now complete. Your cluster nodes should
be ready for work.
