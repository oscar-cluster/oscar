% -*- latex -*-
%
% $Id: cvs.tex,v 1.4 2002/01/23 05:13:41 jsquyres Exp $
%
% $COPYRIGHT$
%

\section{CVS Usage}
\label{sec:cvs}

Portions of the OSCAR package are maintained in CVS.  Checking out the
``{\tt oscar}'' module from the OSCAR CVS repository will create a
copy of a portion of the OSCAR development tree.  The remainder of the
development tree is obtained by invoking a top-level ``{\tt make}''
command.  This will trigger the automatic downloads of any missing
binary packages from various web sites, which will complete the
development tree.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The Golden Rules}

The following Golden Rules will be followed at all times:

\begin{enumerate}
\item {\bf Only check in source code.}  This means not checking in any
  automatically-generated files, such as DVI or postscript files
  generated from \LaTeX, or {\tt configure} scripts generated by {\tt
    autoconf}, etc.
  
\item {\bf Never knowingly commit buggy or untested code.}  While bugs
  are inevitable and unavoidable, please take care to test code before
  committing it back to CVS.  There is nothing more frustrating than
  checking out someone else's code that is blatantly broken.
  
\item {\bf Give meaningful log messages.}  When committing files,
  write meaningful log messages so that not only do other developers
  know what you did, a permanent and easily human-readable history of
  what has happened to each file is maintained.  If the commit fixes a
  specific bug, indicate the bug ID in the log message.
  
\item {\bf Group related patches into a single commit.}  If a specific
  feature or bug fix spans multiple files, isolate the patches related
  to just that feature/bug fix and commit them all at once.  This
  provides modular patches, and helps the developer ensure that {\em
    all} related code is committed.

\item {\bf Do not commit binary files.}  While CVS purportedly has the
  capability to handle binary files, there have been reports of
  inconsistent behavior.  As such, all of OSCAR's binary files will be
  stored outside of the CVS tree.
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Text Files}

Per Section~\ref{sec:file-conventions}, all text files will include
the CVS token ``{\tt \$Id\$}'' within the first few lines.  This will
automatically maintain the last modification time, who committed last,
etc.  

The CVS token ``{\tt \$Log\$}'' will not be used for text files; this
is redundant with the ``{\tt cvs log}'' command.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Binary Files}

{\Huge This whole section may not be relevant -- we've been putting
  binary files in CVS for a while now.}

There will be no binary files stored in CVS.  Instead, all binary
files that are part of OSCAR will be stored on various web
sites.\footnote{As much as possible, the OSCAR binaries will be stored
  on the SourceForge web site.  However, there is at least a ``soft''
  file quota of 100MB on SourceForge.  If we exhaust that limit and
  cannot obtain any more, it is likely that binaries will need to be
  spread across multiple web sites.}

The directory structure on these web sites (relative to some arbitrary
root) will mirror that of the development tree.  For example, the
LAM/MPI RPM packages are located with a relative root of ``{\tt pub}''
on the main OSCAR web site:

\vspace{10pt}

\centerline{\href
  {http://oscar.sf.net/pub/packages/lam/lam-VERSION-usysv.1oscar.i686.rpm}
  {\tt http://oscar.sf.net/pub/packages/lam/lam-VERSION-usysv.1oscar.i686.rpm}}

\centerline{\href
  {http://oscar.sf.net/pub/packages/lam/lam-VERSION-usysv.1oscar.src. rpm}
  {\tt http://oscar.sf.net/pub/packages/lam/lam-VERSION-usysv.1oscar.src.rpm}}

\vspace{10pt}

Lists of which binary files are to be used are included in the {\tt
  Makefile.am} in each directory.  The macro {\tt DOWNLOAD\_\-FILES}
lists files that need to be downloaded that include version numbers in
their names; it is loaded with a list of binary files that should be
obtained.  Each file in this list will be downloaded if it does not
exist in the local directory.  
%
The macro {\tt DOWNLOAD\_\-DATES\_\-FILES} is used to download files
that do not have version numbers in their filenames; these files will
be downloaded if they do not exist in the local directory, or they are
older than the version of the file on the server.
%
Additionally, a top-level file is included in the {\tt Makefile.am}
that will actually do the relevant file tests and downloads.
%
Figure~\ref{fig:makefile-bin-download} shows an example.

\begin{figure}[tbp]
  \begin{center}
\hrule
\vspace{5pt}
\begin{verbatim}
# Some convenience macros are used to hold the http prefix and LAM
# version number.
lam_prefix              = http://oscar.sourceforge.net/pub/packages/lam
lam_version             = 6.5.4

# The DOWNLOAD_FILES macro holds the list of files that will be
# downloaded for this directory.
DOWNLOAD_FILES            = \
        $(lam_prefix)/lam-$(lam_version)-usysv.1oscar.i686.rpm \
        $(lam_prefix)/lam-$(lam_version)-usysv.1oscar.src.rpm

# The DOWNLOAD_DATES_FILES is for files that do not have version
# numbers in them; the files will only be obtained if they do not
# exist locally, or they are older than the copy on the server.
DOWNLOAD_DATES_FILES      = \
        $(lam_prefix)/lam-logo.jpg

# This file includes the logic for the file tests and downloading. The
# use of $(top_srcdir) ensures that this will even work for a VPATH build.
include $(top_srcdir)/dist/Makefile.download
\end{verbatim}
\vspace{5pt}
\hrule
    \caption{Portion of {\tt packages/lam/Makefile.am} that shows how to setup the auto-downloading feature of the development update process.}
    \label{fig:makefile-bin-download}
  \end{center}
\end{figure}

Note that this mechanism only downloads files if they do not exist --
it assumes that new versions of files will have new filenames (since
RPMs and tarballs have version numbers in their filenames).  It is
{\em not} sufficient for keeping a single binary file that does not
change filenames up to date (e.g., {\tt xfig} images).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Development Tree Update Procedure}

Updating an OSCAR development tree is comprised of three parts:

\begin{enumerate}
\item Issue a ``{\tt cvs update}'' in the top-level OSCAR directory.
  This will update the entire source tree, including current lists of
  binary files in OSCAR.
  
\item Re-generate all the automatically generated files, such as {\tt
    configure}.  This typically involves commands such as {\tt
    autoconf}, {\tt automake}, etc.  Following this, run the {\tt
    configure} script to generate a {\tt Makefile} in each directory.

\item Issue a ``{\tt make}'' that will invoke the build system to
  automatically download any new or missing binary files.

{\Huge This step is not currently necessary since we keep all binary
  files in CVS.}
\end{enumerate}

After these three steps, the development tree is considered complete.

{\Huge This {\tt update.sh} script doesn't even exist anymore.}

Since each of these steps involve one or more actual commands, the
entire procedure has been incorporated into a single script in the
OSCAR CVS development tree.  This script can be launched from the
top-level directory is in the OSCAR development tree:

\vspace{10pt}
\centerline{\tt ./dist/update.sh}
\vspace{10pt}

This is the recomended method for all developers to update their
entire CVS trees.

% LocalWords:  Exp oscar DVI autoconf og RPMs gzipped tarballs kb logfile
