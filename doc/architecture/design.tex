% -*- latex -*-
%
% $Id: design.tex,v 1.27 2002/10/29 06:26:32 jsquyres Exp $
%
% $COPYRIGHT$
%

\section{Design of OSCAR 2.0}

In the first generation of OSCAR, the procedure was developed first
and the Wizard was then created to add an easy way to step through the
process. However, by doing so, there was no easy way to modify the
process without redesigning the Wizard. In order to avoid such
problems and to make OSCAR more user friendly, the architecture for
the second generation will be focused around the OSCAR Wizard. As
such, all operations and functionality available to the user will be
initiated from within the Wizard. Similarly, all interaction with the
OS installers, OSCAR Package Management, and OSCAR Data Repository
will be performed by the Wizard.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Directory Structure}

OSCAR 2.0 and later will be installed into the \file{/opt} directory,
in accordance with the Linux Standards Base Filesystem Hierarchy (LSB
FSH).

The major directories for OSCAR 2.0 are:

\begin{itemize}
\item \file{oscar[-<version>]/}: OSCAR base directory.  As described
  in the OSCAR Developer's Guide, this directory will have no version
  number in a developer's copy, and will have a version number in an
  OSCAR distribution package.
  
  All other directories and files listed below are in this top-level
  directory.

\item \file{doc/}: HowTos and other documentation.

\item \file{install\_cluster}: Executable to start the OSCAR Wizard.

\item \file{packages/}: OSCAR packages.

\item \file{COPYING}: GNU General Public License v2.0.
  
\item \file{README}: Quick overview and pointers to documentation.

\item \file{testing/}: OSCAR test suite.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{\file{doc}}

In a distribution package, this directory contains PDF files for OSCAR
documentation.  In a development tree, subdirectories exist containing
the \LaTeX\ source code and images for the OSCAR documentation.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{\file{packages}}

All OSCAR packages are placed in this directory.  Each package is a
self-contained directory in itself.  Placing an OSCAR package
in the \file{packages} directory will make it visible to the OSCAR
installer.  The OSCAR distribution package ships with several ``built
in'' packages, but additional packages may be placed in this directory
before running the OSCAR installer wizard.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{\file{testing}}

The OSCAR test suite is a set of scripts that will call the individual
package test scripts.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Node Installation}

The default OS installer in OSCAR 2.0 will be the System Installation
Suite (SIS), the collaboration between the LUI and SystemImager
projects. As such, the Wizard is designed to work with SIS in order to
install the OS on client machines when users wish to do so.  Any other
future OS installation solutions will also need to be integrated with
the Wizard.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Software Package Management}
\label{sec:design-software-package-mgmt}

The base unit of an OSCAR installation is an RPM.  

\subsubsection{OSCAR-Specific RPM Requirements}
\label{sec:design-software-package-mgmt-rpm-reqs}

OSCAR-specific RPMs should include the string ``{\tt oscar}'' in the
name portion of the RPM filename as well as the {\tt Name:} tag of the
RPM.  For example:

\vspace{10pt}
\centerline{\file{lam-oscar-{\rm X}.{\rm Y}.{\rm Z}-1.i586.rpm}}
\vspace{10pt}

The intent of this convention is to prevent RPM auto-updating packages
from updating an OSCAR-ized RPM to be a non-OSCAR-ized RPM.  For
example, if a Mandrake-like convention was used such that the string
``{\tt oscar}'' was part of the RPM release number instead of part of
the RPM name, an auto-update may replace \file{lam-\-{\rm X}\-.{\rm
    Y}\-.{\rm Z}-\-1oscar\-.i586.rpm} (an OSCAR-ized RPM) with
\file{lam-\-{\rm A}\-.{\rm B}\-.{\rm C}-\-1\-.i586.rpm} (where version
$(A, B, C) > (X, Y, Z)$, of course).

It is also strongly recommended that package RPM files named {\tt
  foo-oscar} provide a ``{\tt Conflict: foo}'' statement such that
they conflict with non-OSCAR-ized RPM of the base name.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{OSCAR Packages}

Introduced in the 1.3 release, the package API outlines the
requirements on a package in order to be included in the OSCAR
distribution.  This API is sufficient for image-based installation and
has been designed with an eventual migration towards either
image-based installation or node-based installation in mind.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Package Philosophy}

OSCAR packages are essentially collections of RPMs that are
selectively installed on nodes within an OSCAR cluster.

The simplest OSCAR package is a single RPM file in a specific
directory structure.  More complex OSCAR packages are also possible,
such as those that contain helper scripts and/or XML-based
configuration that dictates specific installation behavior.  Package
authors can choose simplistic or complex models, depending on the
requirements of their package.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{API Goals}

A package can have helper scripts to provide specific configuration
and customization during the OSCAR installation process.  These
scripts adhere to a specific API, and, if present, are invoked at
strategic points during the OSCAR installation.  The goals of this API
are as follows:

\begin{itemize}
\item support current functionality used in all current OSCAR packages
\item make the API small
\item allow functionality for adding and deleting a node
\item allow functionality for adding a package after the initial
  install
\item preserve the ``do no harm'' mentality
\item allow for small ``bite-size'' increments to the API in
  successive versions, hopefully without having to change the API that
  is in place so far
\end{itemize}

Note that we're still assuming the one-head-node, many-clients model.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Terminology}

The following terminology is used throughout the document:

\begin{itemize}
\item Client filesystem: The filesystem of the client, which may be an
  image on the server, or the filesystem on the client node itself.
  
\item Client node: Every package can partition the cluster nodes into
  server(s) and clients.  In the simplest cluster, every node except
  the head node is a client node for every package.
  
\item Image-based installation: An installation where an ``image'' of
  the node is maintained on a server.  This tree is then used to
  update clients.  This is the current OSCAR installation method,
  implemented by SIS.
  
\item Node-based installation: An installation where each node is
  individually installed and configured.  This is not currently
  implemented by OSCAR, but is expected at a later date.
  
\item Server filesystem: The filesystem on the server itself, {\em
    excluding} any client images that may reside on the server.
  
\item Server node: Every package can partition the cluster nodes into
  server(s) and clients.  In the simplest cluster, the head node is the
  server for every package.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Sequence of Events}

First, let's explain the sequence of events in the OSCAR installation
(see Table~\ref{tab:sequence-of-events}).  This will include the
proposed API calls -- they'll be explained in more detail below.

\begchange

\begin{discuss}
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Need to add verbage about:

  \begin{itemize}
  \item download additional OSCAR packages
  \item run setup API script
  \item read XML config scripts
  \item fill in any missing data (e.g., RPM lists)
  \item select OSCAR packages to install
  \item configure selected OSCAR packages
  \end{itemize}
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{discuss}

\begin{table}[htbp]
  \begin{center}
      \begin{tabular}{rll}
        \hline
        \multicolumn{2}{c}{Description} &
        \multicolumn{1}{c}{Location} \\
        \hline
        1. & Install all the server RPMs & Server filesystem \\
%
        1.1. & Call the API script(s): \cmd{setup} & Server filesystem \\
%
        1.2. & Read XML config files \\
%
        1.3. & ......More stuff about selecting / installing
             packages... \\
%
        2. & Call the API script(s): \cmd{post\_server\_rpm\_install} &
        Server filesystem \\
%
        3. & Install all the client RPMs & Client filesystem \\
%
        4. & Call the API script(s): \cmd{post\_client\_rpm\_install} &
        Client filesystem \\
%
        5. & Define clients in the OSCAR/SIS database & Server
        filesystem \\
%
        6. & Call the API script(s): \cmd{post\_clients} & Server
        filesystem \\
%
        7. & Push the images to the nodes & Server filesystem \\
%
        8. & Call the API script(s): \cmd{post\_install} & Server
        filesystem \\
        \hline
      \end{tabular}
      \caption{Note that step 7 won't happen in a node-based install
        -- this step will be skipped.}
    \label{tab:sequence-of-events}
  \end{center}
\end{table}

Every OSCAR package can have zero or more of the API scripts (this is
different than what we have right now where there is only one
server\_prep script, for example).  At steps 2, 4, 6, and 8 in the
event sequence, each OSCAR package will be examined for the relevant
API scripts.  If it exists, it will be called.  If it does not exist,
that package will be skipped for that step.

Note that this order of events may be slightly different for different
forms of installation.  For example, in a kickstart-oriented
installation, step 5 (define clients in a database) may actually occur
earlier.  However, the order of execution of the API scripts will
still remain the same.

\endchange

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Directory Layout}

OSCAR packages are located under the top-level OSCAR directory, under
the \directory{packages} sub-directory.  Each package has its own
directory, for example, the \package{foo} package will live in the
following directory:

\vspace{10pt}
\centerline{\directory{oscar[-<version>]/packages/foo/}}
\vspace{10pt}

The directory layout of packages under this top-level package
directory is fairly simple:

\begin{itemize}
\item \directory{doc}: Directory where files are located that are
  automatically included in the top-level \file{install.pdf} and
  \file{user.pdf} OSCAR documentation files (see
  Section~\ref{sec:design-pkg-docs}).
  
\item \directory{RPMS}: Directory where the RPMs for the package are
  located.  These RPMs are installed during the normal course of an
  OSCAR installation.

\item \directory{scripts}: Directory where the API scripts are located
  (see Section~\ref{sec:design-pkg-api}).
  
\item \directory{SRPMS}: Directory where the source RPMs for the
  package are located.  These SRPMs are not installed during the OSCAR
  install process -- they are provided for user information only.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Supplemental Files}

Before discussing the API calls, there are some supplemental files
that should be noted.  These supplemental files exist in the top-level
package directory:

\begin{itemize}

\begchange

\item \file{server.rpmlist}: {\em This file is deprecated in favor of
    functionality in \file{config.xml}.  Support for this file will be
    removed in a future OSCAR release.}
  
  This per-package file contains a list of RPM filenames (one per
  line) of RPMs that are installed during step 1.  At present, the RPM
  files listed in this file will be installed on the head node.
  However, once the restriction on a single head node running all
  servers is removed, the server list may be installed on an arbitrary
  node or set of nodes in the cluster (at the user's discretion).
  
  Primitive conflict resolution is run on this list, checking for such
  things as two versions of the same RPM, etc.  However, the majority
  of burden for RPM conflict resolution is up to the package author --
  don't include RPMs that will be problematic.\footnote{ Perhaps
    someday we can relax this constraint, but not for this version.
    It still adheres to the ``do-no-harm'' philosophy, because
    packages that don't have conflicts will still be legal if we do
    eventually introduce sophisticated RPM conflict resolution.}
  
\item \file{client.rpmlist}: {\em This file is deprecated in favor of
    functionality in \file{config.xml}.  Support for this file will be
    removed in a future OSCAR release.}
  
  Same as the server.rpmlist file, except that it contains the RPM
  filenames for the RPMs installed in step 3.
  
\item \file{config.xml} This file is a combination of many different
  configuration items.  It is described in
  Section~\ref{sec:config-xml}.

\end{itemize}

Note that if neither \file{server.rpmlist} nor \file{client.rpmlist}
are present (and no \xmltag{rpmlist} stanzas are listed in the
\file{config.cml} file), then all RPMs will be installed on all nodes.

\endchange

Additionally, if a package is contained within the OSCAR CVS tree,
some optional files may be present in each package's directory
structure.  They can affect the behavior of the top-level ``\cmd{make
  dist}'' and ``\cmd{make oscar-dist}'' -- specifically, which files
are included in the OSCAR distribution packages.

\begin{itemize}
\item \file{.cvsignore}: This file is used to tell CVS to ignore
  certain files when updating.  Specifically, in each directory where
  this file appears, it prevents CVS from noting files that are not
  under CVS control.  The format of the file is listing one file or
  wildcard pattern per line.  This file is typically used to make CVS
  ignore automatically generated files such as \file{Makefile} and
  \file{Makefile.in}.
  
\item \file{.oscar\_ignore}: This file affects the behavior of
  \cmd{autogen.sh}, ``\cmd{make dist}'', and ``\cmd{make oscar-dist}''
  commands.  The presence of this file in a given directory will cause
  the entire tree (rooted at the directory containing the
  \file{.oscar\_\-ignore} file) to be excluded from the distribution
  package.
  
\item \file{Makefile}: This file is typically automatically generated
  (see \file{Makefile.am}, below).  However, package authors may
  choose to supply their own \file{Makefile} instead.  The following
  targets must be supported in the same way as their GNU
  \cmd{automake} counterparts (as documented in the GNU coding
  standards):

  \begin{itemize}
  \item {\tt all}
  \item {\tt clean}
  \item {\tt dist}
  \item {\tt distclean}
  \end{itemize}
  
\item \file{Makefile.am}: This file is typically automatically
  generated by \cmd{autogen.sh}.  If automatically generated, it will
  include all files found in each of the package's directories.  The
  resulting \file{Makefile.in} and \file{Makefile} files that are
  created by \cmd{configure} will be used by ``\cmd{make dist}'' and
  ``\cmd{make oscar-dist}'' to generate OSCAR distribution packages.
  If a package author supplies their own \file{Makefile.am}, the
  \cmd{autogen.sh} script will not overwrite it.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{XML Configuration File}
\label{sec:config-xml}

\begchange

Each package may have a file named \file{config.xml}.
\file{config.xml} is an XML file that contains tags that customize
several different phases of the OSCAR installation process for that
package.  The tags and their hierarchy are described below.

The \xmltag{package} tag is the outer level tag for the entire block.
It contains all other tags in this file. As such, all other tags are
listed in a hierarchical fashion, below.  

Each tag listed below is marked as either ``Mandatory'' or
``Optional''.  Mandatory tags {\em must} be specified -- if they are
not supplied, the XML is considered to be erroneous.  Optional tags
may or may not be supplied; if they are not supplied, a default value
will be assumed.  

Each tag is also marked as ``Singular'' or ``Multi''.  Tags marked as
singular can only have one instance (it is erroneous to have multiple
instances of a Singular tag).  Multi tags can have multiple instances
-- whether there can be one or more instances, or zero or more
instances depends on whether the specific tag is marked as Mandatory
or Optional, respectively.

\begin{itemize}
\item \xmltag{name}: This is a string tag that is the name of the
  package.  It may be a ``fancy'' version of the package's name.  For
  example ``LAM/MPI'', ``C3: Cluster Command and Control'', etc.

  Mandatory/Singular.
  
\item \xmltag{version}: An outer tag containing several sub-tags that
  specify the version number of the package.

  Mandatory/Singular.
  
  \begin{itemize}
  \item \xmltag{major}: An integer major version number of
    the OSCAR package.

    Mandatory/Singular.
    
  \item \xmltag{minor}: An integer minor version number of the OSCAR
    package.

    Mandatory/Singular.
    
  \item \xmltag{subversion}: An integer subversion number of the OSCAR
    package.
    
    Optional/Singular.  If not present, ``0'' is assumed.
    
  \item \xmltag{release}: An integer release number of the OSCAR
    package.
    
    Optional/Singular.  If not present, ``1'' is assumed.
    
  \item \xmltag{epoch}: An integer epoch number of the OSCAR package.
    
    Optional/Singular.  If not present, ``1'' is assumed.
  \end{itemize}
  
  This version number is intentionally analogous to RPM version numbers.
  Put together, the version number can be represented as
  \xmltag{major}.\xmltag{minor}.\xmltag{subversion}-\xmltag{release}.
  The epoch number is not typically displayed, but is used mainly as a
  ``tie breaker'' between multiple otherwise equivalent versions -- it
  is not intended to be typically used (most epochs will be either not
  specified and/or specifically noted as ``1'').
  
\item \xmltag{class}: A string indicating whether the package is a
  core, included, or third party package.  Possible values are:

  \begin{itemize}
  \item \xmlval{core}: indicates that the package is a core package.
  \item \xmlval{included}: indicates that the package is an included
    package.
  \item \xmlval{third-party}: indicates that the package is a third
    party package.
  \end{itemize}

  Mandatory/Singular.
  
\item \xmltag{installable}: An integer indicating whether the package
  is installable or not.\footnote{This field may be changed in the
    pre-configure step of the API.  For example, if pre-configure
    determines that this package cannot be installed on the current
    platform, it may change the value of \xmltag{installable} to be 0
    so that it will not be installed.}  ``\xmlval{0}'' indicates that
  it will not be installed -- all other integer values indicate that
  it will be installed.
  
  Mandatory/Singular.
  
\item \xmltag{summary}: A string presenting a short summary
  description of the package.  This string is typically one (short)
  sentence.
  
  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.

\item \xmltag{license}: A string naming the license of the package.
  
  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.

\item \xmltag{group}: A string naming the functional group of the
  package.  This field is intended to follow the nomenclature of the
  SourceForge Trove categorization names.
  
  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.
  
\item \xmltag{url}: A string presenting the URL of where either the
  OSCAR package or the native package itself may be found.
  
  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.

\item \xmltag{maintainer}: An outter tag indicating the name and/or
  e-mail address of the person / group maintaining the original
  software package.

  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.

  \begin{itemize}
  \item \xmltag{name}: String indicating the name of the OSCAR
    packager.
    
    Optional/Singular.  If supplied, it will be the first portion of
    the ``Maintainer'' combined string.
    
  \item \xmltag{email}: String indicating the e-mail address of the
    package maintainer.
    
    Optional/Singular.  If supplied, it will be the second portion of
    the ``Maintainer'' combined string, and will be enclosed in $<$
    and $>$.
  \end{itemize}

\item \xmltag{packager}: An outter tag indicating the name and/or
  e-mail address of the person / group maintaining the OSCAR package.

  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.

  \begin{itemize}
  \item \xmltag{name}: String indicating the name of the OSCAR
    packager.
    
    Optional/Singular.  If supplied, it will be the first portion of
    the ``Packager'' combined string.
    
  \item \xmltag{email}: String indicating the e-mail address of the
    OSCAR packager.
    
    Optional/Singular.  If supplied, it will be the second portion of
    the ``Packager'' combined string, and will be enclosed in $<$
    and $>$.
  \end{itemize}
    
\item \xmltag{description}: A string describing in some detail the
  contents of the OSCAR package.  This string may be of arbitrary
  length.
  
  Optional/Singular.  If not supplied, the value
  ``\xmlval{$<$none$>$}'' is used.

\item \xmltag{rpmlist}: A top-level tag supplying lists of RPMs to be
  installed by the OSCAR framework.  This functionality is meant to
  replace the now-deprecated \file{server.rpmlist} and
  \file{client.rpmlist} files.  If this tag is supplied, one or more
  scoping stanzas will be listed that contain lists of RPM filenames.  
    
  There are currently only three scoping tags defined.  Each scope, if
  listed, includes one or more \xmltag{rpm} tags.  Primitive conflict
  resolution is run on this list, checking for such things as two
  versions of the same RPM, etc.  However, the majority of burden for
  RPM conflict resolution is up to the package author -- don't include
  RPMs that will be problematic.\footnote{Perhaps someday we can relax
    this constraint, but not yet.}

  Optional/Singular.  If not supplied (and the \file{client.rpmlist}
  and \file{server.rpmlist} files do not exist), then all RPMs found
  in the \file{RPMS} directory will be installed on all nodes.  
  
  \begin{itemize}
  \item \xmltag{all}: Install all the listed RPMs in all available
    scopes.

    Optional/Singular.
    
  \item \xmltag{server}: Install all the listed RPMs on the OSCAR
    server node.

    Optional/Singular.
    
  \item \xmltag{client}: Install all the listed RPMs on the OSCAR
    client nodes.

    Optional/Singular.
  \end{itemize}
  
  It is erroneous to have a \xmltag{rpmlist} stanza without at least
  one scoping tag containing at least one valid \xmltag{rpm} tag.
  
  Each provided scoping tag must contain one or more \xmltag{rpm}
  tags.  Each \xmltag{rpm} tag contains a single RPM filename.
  Typically, only the ``unique'' portion of the RPM filename is
  required, not the entire filename.  For example, the string
  ``\file{lam-oscar}'' is all that is required to specify the RPM
  named \file{lam-oscar-6.5.7-usysv.7.i586.rpm}.

\item \xmltag{provides}: A top-level tag effectively indicating
  synonyms for the package name for use during the dependency
  analysis.  There may be zero or more \xmltag{provides} 
  
  Optional/Multi.  If not supplied, no synonyms for this package
  will be used in the dependency analysis.

  \begin{itemize}
  \item \xmltag{type}: A string indicating the type of dependency.
    Possible values are:

    \begin{itemize}
    \item \xmlval{package}: this synonym indicates an equivalent OSCAR
      package name.
    \end{itemize}

    Mandatory/Singular.
  \item \xmltag{name}: A string indicating a synonym name for this
    package.

    Mandatory/Singular.
  \end{itemize}

\item \xmltag{requires}: A top-level tag effectively indicating
  dependencies for this OSCAR package.  
  
  Optional/Multi.  If not supplied, no dependencies for this package
  will be used in the dependency analysis.  Multiple \xmltag{requires}
  blocks may be specified to list multiple dependencies.

  \begin{itemize}
  \item \xmltag{type}: A string indicating whether the dependency is
    an RPM or another OSCAR package.  Possible values are:

    \begin{itemize}
%    \item \xmlval{rpm}: the dependency is an RPM.
    \item \xmlval{package}: the dependency is another OSCAR package.
    \end{itemize}

    Mandatory/Single.
    
%  \item \xmltag{scope}: A string indicating the scope of the
%    dependency.  Possible values are:

%    \begin{itemize}
%    \item \xmlval{server}: indicates that the dependency only exists
%      on the server node.
%    \item \xmlval{client}: indicates that the dependency only exists
%      on the client nodes.
%    \item \xmlval{all}: indicates that the dependency exists on all
%      nodes.
%    \end{itemize}
    
%    Optional/Single.  If no value is specified, ``\xmlval{all}'' is
%    used.
    
  \item \xmltag{name}: A string indicating the name of the OSCAR
    package that this package depends on.

    Mandatory/Single.
  \end{itemize}
    
\item \xmltag{conflicts}: A top-level tag effectively indicating
  conflicts for this OSCAR package.
  
  Optional/Multi.  If not supplied, no conflicts for this package will
  be used in the dependency analysis.  Multiple \xmltag{conflicts}
  blocks may be specified to list multiple conflicts.

  \begin{itemize}
  \item \xmltag{type}: A string indicating the name of the conflicting
    OSCAR package.  Possible values are:

    \begin{itemize}
%    \item \xmlval{rpm}: the conflict is an RPM.
    \item \xmlval{package}: the conflict is another OSCAR package.
    \end{itemize}

    Mandatory/Single.
    
%  \item \xmltag{scope}: A string indicating the scope of the conflict.
%    Possible values are:

%    \begin{itemize}
%    \item \xmlval{server}: indicates that the conflict only exists on
%      the server node.
%    \item \xmlval{client}: indicates that the conflict only exists on
%      the client nodes.
%    \item \xmlval{all}: indicates that the conflict exists on all
%      nodes.
%    \end{itemize}
    
%    Optional/Single.  If no value is specified, ``\xmlval{all}'' is
%    used.
    
  \item \xmltag{name}: A string indicating the name of the OSCAR
    package that this package conflicts with.

    Mandatory/Single.
    
  \end{itemize}
  
\item \xmltag{download}: A top-level tag indicating where this package
  may be downloaded from.  This tag is typically used in the OSCAR
  Package Downloader (OPD) -- it is not used in the OSCAR installation
  process.
  
  Optional/Singular.  If not specified, this package will not be able
  to be downloaded from anywhere. 

  \begin{itemize}
  \item \xmltag{uri}: A string specifying a full URI from where a
    tarball containing the package can be downloaded from.  See
    Section~\ref{sec:oscar-package-downloader} for more details on the
    OPD and the specifications of this URI.

    Mandatory/Multi.  Multiple URIs may be specified, each of which
    will be treated equivalently.  
    
  \item \xmltag{size}: An integer specifying the size (in bytes) of
    the tarball specified by the \xmltag{uri} tags.

    Mandatory/Single.
    
  \item \xmltag{md5sum}: A string indicating the MD5 sum of the
    tarball specified by the \xmltag{uri} tags.  The string is
    case-insensitive. 
    
    Mandatory/Single.
  \end{itemize}
\end{itemize}

\endchange

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Documentation}
\label{sec:design-pkg-docs}

OSCAR provides a mechanism for packages to get their documentation
included in the top-level \file{install.pdf} and \file{user.pdf}
files.  It is highly recommended that OSCAR package authors provide
OSCAR-specific information about their package with this mechanism.
If additional information is available elsewhere (e.g., a web site, a
text file in an installed RPM, etc.), providing a link or reference to
the external material is strongly encouraged (particularly in the user
documentation).  The user documentation is not necessarily intended to
be a ``one-stop-shop'' for all user-level documentation, but it {\em
  is} intended to be the ``first-stop'' for user-level documentation.
Hence, users should be able to either find the information that they
are looking for, or find a pointer to where they can find the
information that they are looking for.

If there is a file \file{user.tex} in the \directory{doc} package
subdirectory, it will automatically be included in the top-level OSCAR
user manual.  
%
Similarly, if there is a file \file{license.tex} in the same
directory, it will also be included in the OSCAR user manual in the
section containing licenses from all the packages.  {\bf It is {\em
    strongly} recommended that each package include their license in
  the OSCAR user's documentation.}
%
Finally, if there is a file \file{install.tex} in the same directory,
it will automatically be included in the top-level OSCAR installation
manual.  

The following guidelines should be followed when providing
\file{user.tex} and/or \file{install.tex} files:

\begin{itemize}
\item These files should be \LaTeX\ source files.

\item Each file should be a \LaTeX\ subsection -- they will be part of
  a larger section describing details of individual packages in the
  OSCAR distribution.  The first part of each file should be a \LaTeX\
  {\tt subsection} command to start the subsection.

\item The top-level subsection should have a label of the form
      \verb=\label{app:<PKG_NAME>-overview}= where \verb=<PKG_NAME>= is
      the name of the package (same as the directory name), e.g.
         \verb=\label{app:pvm-overview}=.

\item The following macros are available:

  \begin{itemize}
  \item {\tt href}: Takes two arguments -- the first is the string
    text, the second is the text of the link.

  \item {\tt mailto}: Similar to {\tt href}, takes two arguments:
    string text, link text.
  \end{itemize}

\item The following \LaTeX\ packages are included in the top-level
  file and are available to package documentation files:

  \begin{itemize}
  \item \file{times}
  \item \file{graphicx}
  \item \file{fullpage}
  \end{itemize}

\item These files may include other files, such as \LaTeX\ files,
  graphic files, etc.  Note that these files must be included in a
  relative manner, and use the prefix: 

  \vspace{10pt}
  \centerline{\directory{../../packages/foo/doc/<filename>}}
  
\item These files may be built in either Postscript or PDF mode.
  Graphic files must be suitable for both environments.  The {\tt
    figext} macro will be set to ``\file{png}'' when building in PDF
  mode, and will be set to ``\file{eps}'' when building in postscript
  mode.  This can be used in the following manner:

\begin{verbatim}
  \includegraphics{../../packages/foo/doc/my-graphic.\figext}
\end{verbatim}
  
  Alternatively, you can use the {\tt ifpdf} \LaTeX\ logical construct
  to do different things when building in PDF mode versus when
  building in postscript mode:

\begin{verbatim}
  \ifpdf
     % Do things for PDF mode
  \else
     % Do things for postscript mode
  \fi
\end{verbatim}

\end{itemize}

Note that the top-level OSCAR user and installation documents are only
buildable from within an OSCAR CVS tree -- they are not buildable from
an OSCAR distribution package.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{API calls}
\label{sec:design-pkg-api}

The environment that these API calls are executed under has the 
following variables defined that may be useful:

\begin{table}[htbp]
  \begin{center}
    \begin{tabular}{|l|p{3in}|}
      \hline
      \multicolumn{1}{|c|}{Variable} &
      \multicolumn{1}{|c|}{Contents} \\
      \hline
      \hline
      \envvar{OSCAR\_HEAD\_INTERNAL\_INTERFACE} & The network
      interface on the head node that connects to the cluster (e.g.,
      \file{eth0}).\\
%
      \hline
      \envvar{OSCAR\_HOME} & The root path of the OSCAR tree 
      (e.g., \file{/root/oscar-1.4}). \\ 
%
      \hline
      \envvar{OSCAR\_TESTPRINT} & The full filename for the
      \cmd{testprint} tool (e.g., \file{/root/oscar-1.4/testing/testprint}).i
      only provide to the test scripts.\\ 
%
      \hline
    \end{tabular}
    \caption{OSCAR API environment variables}
    \label{tab:design-pkg-api-env}
  \end{center}
\end{table}

So let's now discuss each of the API calls in detail.

\begin{itemize}

\begchange

\item \file{setup} (step N)
  
  This script is called before anything else happens with the package.
  It is intended to allow packages to customize themselves for the
  particular system that they are being installed on (analogous to GNU
  \cmd{configure} scripts).  This customization typically involes
  running some tests and then writing (or re-writing) the package's
  XML configuration file (this step is run before the OSCAR framework
  reads the package's XML configuration file).  Hence, typical actions
  that the \cmd{setup} API script can perform include: selecting a set
  of system-specific RPMs to be installed, declaring that the package
  is not installable on this system, etc.

  Guidelines:

  \begin{itemize}
  \item This script will be run on the head node.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster.
  \item This script can {\em only} modify anything on the server
    filesystem, but must restrict itself to only things that are
    relevant to that package.
  \item This script cannot modify any client filesystems.
  \item This script cannot use anything from the OSCAR/SIS database,
    because there isn't much (any?) information in it yet.
  \end{itemize}

  Parameters:
  
  \begin{itemize}
  \item None.
  \end{itemize}

\endchange
  
\item \file{post\_server\_rpm\_install} (step 2)\footnote{A deprecated
    filename of this script is \file{post\_\-server\_\-install}.  The
    new name \file{post\_server\_rpm\_install} should be used in all
    new OSCAR packages.}
  
  Guidelines:

  \begin{itemize}
  \item This script will be run on the head node.
  \item This use of this API script is strongly discouraged.  The
    contents of this script should normally be contained in the \%post
    scripts in the RPMs themselves.  This API script is only here to
    help taking third party non-OSCAR-ized RPMs and graft them into
    the OSCAR framework without needing to re-make the RPM.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster.
  \item This script can {\em only} modify anything on the server
    filesystem, but should restrict itself to only things that are
    relevant to that package.
  \item This script cannot modify any client filesystems.
  \item This script cannot use anything from the OSCAR/SIS database,
    because there isn't much (any?) information in it yet.
  \end{itemize}

  Parameters:
  
  \begin{itemize}
  \item None.
  \end{itemize}
  
\item \file{post\_client\_rpm\_install} (step 4)\footnote{A deprecated
    filename of this script is \file{post\_\-rpm\_\-install}.  The new
    name \file{post\_client\_rpm\_install} should be used in all new
    OSCAR packages.}  
  
  Guidelines:

  \begin{itemize}
  \item This script will be run on the client filesystem.  That is, it
    will either be chrooted to the image or run on all of the actual
    nodes themselves.
  \item This use of this API script is strongly discouraged.  The
    contents of this script should normally be contained in the \%post
    scripts in the RPMs themselves.  This API script is only here to
    help taking third party non-OSCAR-ized RPMs and graft them into
    the OSCAR framework without needing to re-make the RPM.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster.
  \item This script can modify anything on the client filesystem, but
    should restrict itself to only things that are relevant to that
    package.
  \item This script cannot use anything from the OSCAR/SIS database
    \footnote{This may change in future versions of the API, but for
      now, nothing in the OSCAR/SIS DB is available during this step.}
    The only piece of global information that is available is the
    hostname oscar\_server, which will be set correctly in the
    /etc/hosts on every node/image.
  \end{itemize}

  Parameters:

  \begin{itemize}
  \item None.
  \end{itemize}

\item \file{post\_clients} (step 6)

  Guidelines:

  \begin{itemize}
  \item This script will only be run on the head node.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster (e.g., when nodes are
    added/deleted, packages are added, etc.)
  \item This script can modify anything on the server filesystem, but
    should restrict itself to only things that are relevant to that
    package.
  \item This script can NOT modify anything on client filesystems.
  \item This script can read any information in the OSCAR/SIS database
    (no write operations are supported).  Using the OSCAR/SIS database
    API is the only way to read the database (see Section~\ref{sec:api-utils}).
  \end{itemize}

  Parameters:

  \begin{itemize}
  \item None.
  \end{itemize}
  
  \file{post\_install} (step 8)

  Guidelines:
  
  \begin{itemize}
  \item This script will only be run on the head node.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster (e.g., when nodes are
    added/deleted, packages are added, etc.)
  \item This script can modify anything on the server filesystem, but
    should restrict itself to only things that are relevant to that
    package.
  \item This script can NOT modify anything on client filesystems.
  \item This script can read any information in the OSCAR/SIS database
    (no write operations are supported).  Using the OSCAR/SIS database
    API is the only way to read the database (see Section~\ref{sec:api-utils}).
  \end{itemize}

  Parameters:
  
  \begin{itemize}
  \item None.
  \end{itemize}

  \file{test\_root}

  Guidelines:
  \begin{itemize}
  \item This script will only be run as root on the head node.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster (e.g., when nodes are
    added/deleted, packages are added, etc.)
  \item Any test cases that require root authority should be executed
    in this script.
  \item This script should return 0 if all tests succeed or 1 if any
    fail.
  \item Any status output should use the \cmd{testprint} tool
    (see Section~\ref{sec:api-utils}).
  \end{itemize}

  Parameters:
  
  \begin{itemize}
  \item A space delimited list of client nodes.
  \end{itemize}

  \file{test\_user}

  Guidelines:
  \begin{itemize}
  \item This script will only be run as a test user on the head node.
  \item This script must be safely re-runnable; it may be run multiple
    times over the life of the cluster (e.g., when nodes are
    added/deleted, packages are added, etc.)
  \item Any test cases that don't require root authority should be executed
    in this script.
  \item This script should return 0 if all tests succeed or 1 if any
    fail.
  \item Any status output should use the \cmd{testprint} tool
    (see Section~\ref{sec:api-utils}).
  \end{itemize}

  Parameters:
  
  \begin{itemize}
  \item A space delimited list of client nodes.
  \end{itemize}

\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Notes about RPMs}

Because we anticipate eventually allowing upgrading of OSCAR packages,
OSCAR RPMs should cleanly allow ``\cmd{rpm -Uvh}'' operations.

Additionally, the \%post scripts in an RPM should be used whenever
possible instead of steps 2 and 4
(\cmd{post\_\-server\_\-rpm\_\-install} and
\cmd{post\_\-client\_\-rpm\_\-install}).  Steps 2 and 4 are intended
to allow random, non-OSCAR-ized, third-party RPMs to become OSCAR
packages by adding a script instead of needing to re-make the RPM with
the appropriate \%post scripts.

Scripts in an RPM (such as \%pre and \%post) [currently] cannot use any
OSCAR database API calls, such as obtaining the number of nodes in an
OSCAR cluster.  Future versions of this API may allow such calls, but
with the stipulation that RPMS that invoke OSCAR database API calls
depend on some OSCAR-specific RPM that provide the database API calls
themselves.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Major actions and how the API is used}

\noindent {\bf Initial OSCAR install}

Run all steps -- 1 through 8 (of course, skip step 5 if using a
node-based install).

\begin{enumerate}
\item Install all the server RPMs
\item Call the API script(s): \cmd{post\_server\_rpm\_install}
\item Install all the client RPMs
\item Call the API script(s): \cmd{post\_client\_rpm\_install}
\item Define clients in the OSCAR/SIS database
\item Call the API script(s): \cmd{post\_clients}
\item Push the images to the nodes
\item Call the API script(s): \cmd{post\_install}
\end{enumerate}

\noindent {\bf Add a package after the initial OSCAR install}

Run steps 1 through 4, and then steps 6 through 8.  Step 5 is not
necessary because all the clients have already been defined --
modifying the OSCAR/SIS database is not necessary just to install a
new package.

\begin{enumerate}
\item Install all the server RPMs
\item Call the API script(s): \cmd{post\_server\_rpm\_install}
\item Install all the client RPMs
\item Call the API script(s): \cmd{post\_client\_rpm\_install}
\item $<$skipped$>$
\item Call the API script(s): \cmd{post\_clients}
\item Push the images to the nodes
\item Call the API script(s): \cmd{post\_install}
\end{enumerate}

\noindent {\bf Add a node after the initial OSCAR install}

Run steps 5 through 8.  This allows packages to reconfigure themselves
if they need to, based upon the addition of a new node in the cluster
(canonical example: PBS).

\begin{enumerate}
\item $<$skipped$>$
\item $<$skipped$>$
\item $<$skipped$>$
\item $<$skipped$>$
\item Define clients in the OSCAR/SIS database
\item Call the API script(s): \cmd{post\_clients}
\item Push the images to the nodes
\item Call the API script(s): \cmd{post\_install}
\end{enumerate}


\noindent {\bf Remove a node after the initial OSCAR install}

Run steps 5 through 8.  This allows packages to reconfigure themselves
if they need to, based upon the deletion of a new node in the cluster
(canonical example: PBS).

\begin{enumerate}
\item $<$skipped$>$
\item $<$skipped$>$
\item $<$skipped$>$
\item $<$skipped$>$
\item Define clients in the OSCAR/SIS database
\item Call the API script(s): \cmd{post\_clients}
\item Push the images to the nodes
\item Call the API script(s): \cmd{post\_install}
\end{enumerate}


\subsubsection{Utilities available to the API calls.}
\label{sec:api-utils}
\noindent {\bf Accessing the OSCAR/SIS database}

NOTE: It is required that all API scripts which need node information be
written in Perl, and use the following function to gain access to the
database.

The SystemInstaller::Machine class exports a convenience function
called \cmd{get\_machine\_listing}.  This can optionally take an image
name as the argument.\footnote{There should be a description of how to
  use this here...}

\begin{discuss}
SIS Guys - How do we import this function in our perl scripts?
\end{discuss}

\cmd{get\_machine\_listing} returns a hash.  The hash keys are the
names of all the clients in the database (optionally associated with
an image if that is specified).  The hash value for each key is a hash
reference with the following keys defined:

\begin{verbatim}
  Key     Value
  ------- -----------------------------
  HOST    hostname
  IPADDR  ip address of primary adapter
  DOMAIN  domainname
  NUMPROC number of processors on node
  ------- -----------------------------
  (other values can be added if required)
\end{verbatim}

It is recommended that all user exit scripts which need node
information be written in Perl, and use this function to gain access
to the database.

Note that this function is currently SIS-specific, and will likely
change in future versions of this API.

\noindent{\bf Providing output from test scripts}

In order to provide consistent output from all the test scripts, OSCAR
provides a tool, \cmd{testprint}. When printing status of a test, this tool
should be used. The environment variable \envvar{OSCAR\_TESTPRINT} will
give the filename of this tool since it varies for the root and user 
tests. The flags for \cmd{testprint} are:
\begin{itemize}
\item -l "label"  Specifies the test name. This is required.
\item -s "status" Specifies the status test. This is optional and can be 
                  used for timeout countdowns or subtasks.
\item -p          Indicates that the test is complete and it passed.
\item -f          Indicates that the test is complete and it failed.
\end{itemize}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Points still unresolved}

These issues can be addressed for API versions after 1.3.

\begin{enumerate}
\item How to do upgrades of packages?
\item How to do upgrades of the entire OSCAR cluster?
\item How to do package inter-relationships?
\item How to remove a package?
\item How to make OSCAR DB remotely available (for step 4)?
\item An API for package testing so that packages can include their
  own tests and have a top-level (OSCAR) test manager invoke them
  
\item Will need to make OSCAR DB info available remotely (in the
  chroot jail or on the nodes) for post 2.0 for node-based installs --
  perhaps some socket-based thingy.  Punted for now 'cause we'll be
  image-based until 2.0.  Making it remotely accessible will make
  OSCAR DB info in step 4.
\end{enumerate}

% LocalWords:  Exp Filesystem LSB FSH oscar doc HowTos Docs pkgname ODR CLAMDR
% LocalWords:  readDR pl writeDR IP DDR ETMASK ONFIG CONFIG dhcp Hostname eth
% LocalWords:  FQDN OUTE NUM ROCS EAD ERSION YPE PACKAGELIST packagelist Webmin
% LocalWords:  HOSTLIST hostlist headnode hostname backend CGI Perl LUI API un
% LocalWords:  SystemImager backends uninstall Uninstallation init geiselha OPM
% LocalWords:  uninstallation tarball pkgconfig atboot Solaris pkg contrib OCG
% LocalWords:  AC EFAULT accessor ODRs integrators verbage vs admin opkgconfig
% LocalWords:  integrator txt naughtont
