# $Id$

%define libpref PERLLIBPATH
%define bindir /usr/bin
%define etcdir /etc/oscar
%define docdir /usr/share/doc/oscar
%define sharedir /usr/share/oscar
%define mandir /usr/local/man/man1
%define _unpackaged_files_terminate_build 0

%define opkgc_version 0.6.0
%define packman 3.2.0

Summary: 	OSCAR package
Name: 		oscar
Version: 	OSCARVERSION
Release: 	1
License: 	GPL
URL: 		http://oscar.openclustergroup.org
Group: 		Applications/System
Source: 	%{name}-%{version}.tar.gz
Requires: 	%{name}-base-lib == %{version}-%{release}
Requires: 	%{name}-base-scripts == %{version}-%{release}
Requires:	%{name}-base == %{version}-%{release}
Requires: 	yum, createrepo, yume
Vendor: 	OSCAR
Distribution: 	OSCAR
Packager: 	Geoffroy Vallee

Buildroot: 	%{_tmppath}/%{name}-%{version}-root
BuildArch: 	noarch
AutoReqProv: 	no

%description
OSCAR package.
"Virtual" package that installs the basic dependencies to have OSCAR able to
bootstrap using RPMs.
%prep
%setup -n %{name}-%{version}
/usr/bin/patch -s -p1 share/prereqs/base/prereq.cfg debian/patches/01_base_prereq.patch
%build
rm -rf %{buildroot}
make install DESTDIR=%{buildroot}
mkdir -p %{buildroot}%{etcdir}
mkdir -p %{buildroot}%{docdir}
mkdir -p %{buildroot}%{sharedir}/images
cp -f COPYING %{buildroot}%{docdir}
cp -f README %{buildroot}%{docdir}
cp -f VERSION %{buildroot}%{docdir}
cp -f images/oscar.gif %{buildroot}%{sharedir}/images
cp -rf packages/yume/ %{buildroot}%{sharedir}/prereqs
cp -rf packages/rapt/ %{buildroot}%{sharedir}/prereqs
cp -rf packages/oda/  %{buildroot}%{sharedir}/prereqs
%clean
rm -rf %{_tmppath}/%{name}-%{version}-root
%files
%defattr(-,root,root)

%package -n oscar-base
Group: Applications/System
Summary: Base OSCAR package
AutoReqProv: no
Requires: oscar-base-scripts == %{version}-%{release}
%description -n oscar-base
Base OSCAR package.
OSCAR allows users, regardless of their experience level with a *nix
environment, to install a Beowulf type high performance computing cluster. It
also contains everything needed to administer and program this type of HPC
cluster. OSCAR's flexible package management system has a rich set of
pre-packaged applications and utilities which means you can get up and running
without laboriously installing and configuring complex cluster administration
and communication packages. It also lets administrators create customized
packages for any kind of distributed application or utility, and to distribute
those packages from an online package repository, either on or off site.
rm -rf %{_tmppath}/%{name}-%{version}-root
%post -n oscar-base
/usr/bin/oscar-config --generate-config-file
/usr/bin/oscar-updater
%files -n oscar-base
%defattr(-,root,root)
%dir %{etcdir}
%dir %{sharedir}/prereqs
%dir %{mandir}
%{etcdir}/*
%{sharedir}/*
%{mandir}/*
%{docdir}/*

%package -n oscar-base-client
Group: Applications/System
Summary: Libraries for OSCAR clustering package.
AutoReqProv: no
%description -n oscar-base-client
Requires: %{name}-base-scripts == %{version}-%{release}
Dummy package for oscar-base-client install.
%files -n oscar-base-client
%defattr(-,root,root)

%package -n oscar-base-server
Group: Applications/System
Summary: Libraries for OSCAR clustering package.
AutoReqProv: no
%description -n oscar-base-server
Requires: %{name}-base == %{version}-%{release}
Dummy package for oscar-base-server install.
%files -n oscar-base-server
%defattr(-,root,root)

%package -n oscar-base-lib
Group: Applications/System
Summary: Libraries for OSCAR clustering package.
Requires:   perl-XML-Simple
Requires:   perl-AppConfig
AutoReqProv: no
%description -n oscar-base-lib
Libraries for OSCAR clustering base package.
%files -n oscar-base-lib
%defattr(-,root,root)
%dir %{libpref}
%{libpref}/*

%package -n oscar-base-scripts
Group: Applications/System
Summary: Libraries for OSCAR clustering package.
Requires: %{name}-base-lib == %{version}-%{release}
Requires: syslinux
AutoReqProv: no
%description -n oscar-base-scripts
Scripts for OSCAR clustering base package.
%files -n oscar-base-scripts
%defattr(-,root,root)
%dir %{bindir}
%dir %{bindir}/system-sanity.d
%{bindir}/*

%package -n oscar-devel
Group: Applications/System
Summary: Everything needed for OSCAR related developments
Requires: %{name}-base == %{version}-%{release}
Requires: opkgc >= %{opkgc_version}
Requires: packman >= %{packman_version}
Requires: createrepo
AutoReqProv: no
%description -n oscar-devel
Everything needed for OSCAR related developments.
%files -n oscar-devel
%defattr(-,root,root)

%changelog
* Thu Mar 03 2011 Geoffroy Vallee <valleegr@ornl.gov>
- Add a oscar-devel packages.
* Sat Jan 31 2009 Geoffroy Vallee <valleegr@ornl.gov>
- Merge the oscar.spec.in and oscar-base.spec.in files.
- Re-organize the spec file to start to address issues with FC10.
* Tue Dec 02 2008 Geoffroy Vallee <valleegr@ornl.gov>
- Add the /usr/bin/system-sanity.d directory into the scripts RPM.
* Wed Nov 26 2008 Geoffroy Vallee <valleegr@ornl.gov>
- Modify the spec file to be based on the Makefile.
- Install OSCAR directly into the system, instead of using /opt.
* Thu Nov 29 2007 Bernard Li <bernard@vanhpc.org>
- Added directories to the %files sections so that they will be removed
  when the RPMs are uninstalled
* Thu Oct 4 2007 Erich Focht
- Initial package.
